<!DOCTYPE html>
<html  xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive AI Hologram With Oracle Database</title>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.0/css/bootstrap.min.css"
          crossorigin="anonymous">
    <style>
        body {
            text-align: center;
            padding: 20px;
            background-color: #2A2F2F;
            color: #F1EFED;
        }
        h1, p, label {
            color: #F1EFED;
        }
        #transcription {
            color: #000000;
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            background: white;
            width: 90%;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
            min-height: 100px;
            overflow-y: auto;
            text-align: left;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }
        button {
            margin-top: 10px;
            color: #F1EFED;
        }
        .radio-group {
            margin-top: 15px;
            text-align: left;
        }
        .radio-group label {
            display: block;
            margin-bottom: 5px;
        }
        .flags {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .flags img {
            width: 30px;
            height: 20px;
            margin-left: 5px;
        }
        .bottom-links {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .bottom-links a {
            margin: 0 10px;
        }
        .bottom-links img {
            width: 200px;
            height: auto;
        }
    </style>
</head>
<body>

<!-- Language selection -->
<div class="flags">
    <a href="aiholo?languageCode=he-IL"><img src="../images-aiholo/Flags/ko-KO.svg" alt="Korean"></a>
    <a href="aiholo?languageCode=he-IL"><img src="../images-aiholo/Flags/he-IL.svg" alt="Hebrew"></a>
    <a href="aiholo?languageCode=de-DE"><img src="../images-aiholo/Flags/de-DE.svg" alt="German"></a>
    <a href="aiholo?languageCode=es-MX"><img src="../images-aiholo/Flags/es-MX.svg" alt="Spanish (Mexico)"></a>
    <a href="aiholo?languageCode=hi-IN"><img src="../images-aiholo/Flags/hi-IN.svg" alt="Hindi (India)"></a>
    <a href="aiholo?languageCode=pt-BR"><img src="../images-aiholo/Flags/pt-BR.svg" alt="Portuguese"></a>
    <a href="aiholo?languageCode=es-ES"><img src="../images-aiholo/Flags/es-ES.svg" alt="Spanish"></a>
    <a href="aiholo?languageCode=zh-SG"><img src="../images-aiholo/Flags/zh-SG.svg" alt="Chinese (Singapore)"></a>
    <a href="aiholo?languageCode=it-IT"><img src="../images-aiholo/Flags/it-IT.svg" alt="Italian"></a>
    <a href="aiholo?languageCode=en-GB"><img src="../images-aiholo/Flags/en-GB.svg" alt="English (GB)"></a>
    <a href="aiholo?languageCode=ar-ae"><img src="../images-aiholo/Flags/ar-AE.svg" alt="Arabic-UAE"></a>
    <a href="aiholo?languageCode=ja-JP"><img src="../images-aiholo/Flags/ja-JP.svg" alt="Japanese"></a>
    <a href="aiholo?languageCode=fr-FR"><img src="../images-aiholo/Flags/fr-FR.svg" alt="France"></a>
    <a href="aiholo?languageCode=ga-IE"><img src="../images-aiholo/Flags/ga-GA.svg" alt="Ireland"></a>
    <a href="aiholo?languageCode=ro-RO"><img src="../images-aiholo/Flags/ro-RO.svg" alt="Romania"></a>
    <a href="aiholo?languageCode=en-AU"><img src="../images-aiholo/Flags/en-AU.svg" alt="Australia"></a>
    <a href="aiholo?languageCode=en-US"><img src="../images-aiholo/Flags/en-US.svg" alt="English (United States)"></a>

    &nbsp;Current:
    <img th:src="@{'/images-aiholo/Flags/' + ${languageCode} + '.svg'}"
         th:alt="${languageCode}"
         style="width: 30px; height: 20px;">
</div>

<br><br>
<h2>Interactive AI Holograms With Oracle AI Database</h2>
<h5>Ask questions and get verbal and/or visual replies!</h5>

<!-- ‚úÖ Correctly sets languageCodeSTT for STT using Thymeleaf -->
<script th:inline="javascript">
    var languageCodeSTT = /*[[${languageCode} ?: 'pt-BR']]*/ 'pt-BR';
    var voiceName = /*[[${voiceName} ?: 'pt-BR-Wavenet-D']]*/ 'pt-BR-Wavenet-D';
    // Default TTS mode - GCP is the primary, most reliable option
    var ttsMode = 'GCP';
    var llmModel = 'gpt-4'; // Default LLM model
    var audio2FaceEnabled = /*[[${audio2FaceEnabled} ?: false]]*/ false;
    var audioDelayMs = /*[[${audioDelayMs} ?: 500]]*/ 500;
    
    // Dual audio configuration
    var enableDualAudioOutput = /*[[${enableDualAudioOutput} ?: true]]*/ true;
    var audioDeviceA = /*[[${audioDeviceA} ?: 'CABLE Input (VB-Audio Virtual Cable)']]*/ 'CABLE Input (VB-Audio Virtual Cable)';
    var audioDeviceB = /*[[${audioDeviceB} ?: 'Speakers (VB-Audio Voicemeeter VAIO)']]*/ 'Speakers (VB-Audio Voicemeeter VAIO)';
    
    console.log("Using Speech Recognition Language: " + languageCodeSTT + " and VoiceName: " + voiceName);
    console.log("Speech Recognition Language Code:", languageCodeSTT);
    console.log("Audio2Face enabled:", audio2FaceEnabled);
    console.log("Audio delay:", audioDelayMs + "ms");
    console.log("Dual audio output:", enableDualAudioOutput);
    console.log("Audio Device A (Stream A ‚Üí Unreal):", audioDeviceA);
    console.log("Audio Device B (Stream B ‚Üí Zoom):", audioDeviceB);

    const voiceOptionsByLanguage = {
        "en-US": [
            { value: "en-US-Chirp3-HD-Aoede", label: "Aoede (HD female)" },
            { value: "en-US-Wavenet-F", label: "Wavenet F" },
            { value: "en-US-Wavenet-G", label: "Wavenet G" },
            { value: "en-US-Wavenet-H", label: "Wavenet H" },
            { value: "en-US-Neural2-F", label: "Neural2 F" },
            { value: "en-US-Neural2-G", label: "Neural2 G" },
            { value: "en-US-Neural2-H", label: "Neural2 H" },
            { value: "en-US-Studio-O", label: "Studio O" }
        ],
        "en-GB": [{ value: "en-GB-Wavenet-A", label: "Wavenet A" }],
        "en-AU": [{ value: "en-AU-Wavenet-A", label: "Wavenet A" }],
        "pt-BR": [{ value: "pt-BR-Wavenet-D", label: "Wavenet D" }],
        "es-ES": [{ value: "es-ES-Wavenet-D", label: "Wavenet D" }],
        "es-MX": [{ value: "es-US-Wavenet-A", label: "Wavenet A" }],
        "fr-FR": [{ value: "fr-FR-Wavenet-A", label: "Wavenet A" }],
        "de-DE": [{ value: "de-DE-Wavenet-A", label: "Wavenet A" }],
        "it-IT": [{ value: "it-IT-Wavenet-A", label: "Wavenet A" }],
        "ro-RO": [{ value: "ro-RO-Wavenet-A", label: "Wavenet A" }],
        "zh-SG": [{ value: "cmn-CN-Wavenet-A", label: "Wavenet A" }],
        "zh-CN": [{ value: "cmn-CN-Wavenet-A", label: "Wavenet A" }],
        "ja-JP": [{ value: "ja-JP-Wavenet-A", label: "Wavenet A" }],
        "hi-IN": [{ value: "hi-IN-Wavenet-A", label: "Wavenet A" }],
        "he-IL": [{ value: "he-IL-Wavenet-A", label: "Wavenet A" }],
        "ar-AE": [{ value: "ar-AE-Wavenet-A", label: "Wavenet A" }],
        "ga-GA": [{ value: "ga-GA-Wavenet-A", label: "Wavenet A" }],
        "ga-IE": [{ value: "ga-GA-Wavenet-A", label: "Wavenet A" }]
    };

    const ttsModeOptions = [
        { value: 'GCP', label: 'Google Cloud TTS (default)' },
        { value: 'COQUI_FAST', label: 'Coqui - Fast (lower latency)' },
        { value: 'COQUI_BALANCED', label: 'Coqui - Balanced' },
        { value: 'COQUI_QUALITY', label: 'Coqui - Quality (highest fidelity)' },
        { value: 'OCI', label: 'Oracle Cloud TTS (preview)' }
    ];

    const llmModelOptions = [
        { value: 'gpt-4o', label: 'GPT-4o (latest, fastest)' },
        { value: 'gpt-4o-mini', label: 'GPT-4o Mini (affordable)' },
        { value: 'gpt-4-turbo', label: 'GPT-4 Turbo (128K context)' },
        { value: 'gpt-4', label: 'GPT-4 (default)' },
        { value: 'gpt-4-32k', label: 'GPT-4 32K (extended context)' },
        { value: 'gpt-3.5-turbo', label: 'GPT-3.5 Turbo (fast, budget)' },
        { value: 'gpt-3.5-turbo-16k', label: 'GPT-3.5 16K' }
    ];

    function initVoiceDropdown() {
        const select = document.getElementById("voiceNameSelect");
        if (!select) {
            return;
        }

        const options = voiceOptionsByLanguage[languageCodeSTT] || [{ value: voiceName, label: voiceName }];
        select.innerHTML = "";
        options.forEach(option => {
            const opt = document.createElement("option");
            opt.value = option.value;
            opt.textContent = option.label;
            select.appendChild(opt);
        });

        if (!options.some(option => option.value === voiceName)) {
            voiceName = options[0].value;
        }
        select.value = voiceName;
        const footerVoiceInput = document.getElementById("footerVoiceName");
        if (footerVoiceInput) {
            footerVoiceInput.value = voiceName;
        }

        select.addEventListener("change", (event) => {
            voiceName = event.target.value;
            console.log("Voice selection updated to", voiceName);
            if (footerVoiceInput) {
                footerVoiceInput.value = voiceName;
            }
        });
    }

    function initTtsDropdown() {
        const select = document.getElementById("ttsModeSelect");
        if (!select) {
            return;
        }

        select.innerHTML = "";
        ttsModeOptions.forEach(option => {
            const opt = document.createElement("option");
            opt.value = option.value;
            opt.textContent = option.label;
            select.appendChild(opt);
        });

        if (!ttsModeOptions.some(option => option.value === ttsMode)) {
            ttsMode = 'GCP';
        }
        select.value = ttsMode;

        const footerTtsInput = document.getElementById("footerTtsMode");
        if (footerTtsInput) {
            footerTtsInput.value = ttsMode;
        }

        select.addEventListener("change", (event) => {
            ttsMode = event.target.value;
            console.log("TTS engine selection updated to", ttsMode);
            if (footerTtsInput) {
                footerTtsInput.value = ttsMode;
            }
        });
    }

    function initAudioDelayInput() {
        const input = document.getElementById("audioDelayInput");
        if (!input) {
            return;
        }

        input.value = audioDelayMs;

        input.addEventListener("change", (event) => {
            audioDelayMs = parseInt(event.target.value, 10);
            console.log("Audio delay updated to", audioDelayMs + "ms");
        });
    }

    function initDualAudioInputs() {
        const dualAudioCheckbox = document.getElementById("enableDualAudioOutput");
        const deviceAInput = document.getElementById("audioDeviceA");
        const deviceBInput = document.getElementById("audioDeviceB");

        if (dualAudioCheckbox) {
            dualAudioCheckbox.checked = enableDualAudioOutput;
            dualAudioCheckbox.addEventListener("change", (event) => {
                enableDualAudioOutput = event.target.checked;
                console.log("Dual audio output", enableDualAudioOutput ? "enabled" : "disabled");
            });
        }

        if (deviceAInput) {
            deviceAInput.value = audioDeviceA;
            deviceAInput.addEventListener("change", (event) => {
                audioDeviceA = event.target.value;
                console.log("Audio Device A updated to:", audioDeviceA);
            });
        }

        if (deviceBInput) {
            deviceBInput.value = audioDeviceB;
            deviceBInput.addEventListener("change", (event) => {
                audioDeviceB = event.target.value;
                console.log("Audio Device B updated to:", audioDeviceB);
            });
        }
    }

    function initLlmDropdown() {
        const select = document.getElementById("llmModelSelect");
        if (!select) {
            return;
        }

        select.innerHTML = "";
        llmModelOptions.forEach(option => {
            const opt = document.createElement("option");
            opt.value = option.value;
            opt.textContent = option.label;
            select.appendChild(opt);
        });

        if (!llmModelOptions.some(option => option.value === llmModel)) {
            llmModel = 'gpt-4';
        }
        select.value = llmModel;

        select.addEventListener("change", (event) => {
            llmModel = event.target.value;
            console.log("LLM model selection updated to", llmModel);
        });
    }
    
    function initDocSimilarityThreshold() {
        const input = document.getElementById("docSimilarityThreshold");
        if (!input) {
            return;
        }

        input.addEventListener("change", (event) => {
            const threshold = parseFloat(event.target.value);
            if (threshold >= 0.0 && threshold <= 1.0) {
                fetch(`/config/docSimilarityThreshold?threshold=${threshold}`, {
                    method: 'POST'
                })
                .then(response => response.text())
                .then(result => {
                    console.log("Doc similarity threshold updated:", result);
                })
                .catch(error => {
                    console.error("Error updating doc similarity threshold:", error);
                });
            }
        });
    }
</script>

<div class="container mt-3" style="max-width: 1200px;">
    <!-- Centered instructions -->
    <div class="row justify-content-center">
        <div class="col-12 text-center">
            <p style="margin-bottom: 20px; margin-top: 0;">
                1. Click and hold the mic button below.<br>
                2. Speak your question or command.<br>
                3. Release the mic button.<br>
                (Click the trash bin to clear conversation)
            </p>
        </div>
    </div>
    
    <!-- Centered buttons row -->
    <div class="row justify-content-center">
        <div class="col-12">
            <div style="display: flex; justify-content: center; align-items: start; gap: 40px; flex-wrap: wrap;">
                <!-- Mic and Clear buttons -->
                <div class="d-flex flex-column align-items-center">
                    <span style="font-size: 14px; margin-bottom: 2px;">Speak</span>
                    <button id="singleBtnMode" class="btn btn-primary" style="background: none; border: none; padding: 0;">
                        <img id="singleBtnIcon" src="../images-aiholo/Icons/Yellow/Microphone.svg" alt="Single Button Mode" style="width: 70px; height: auto;">
                    </button>
                </div>
                <div class="d-flex flex-column align-items-center">
                    <span style="font-size: 14px; margin-bottom: 2px;">Clear</span>
                    <button id="clearBtn" class="btn btn-primary" style="background: none; border: none; padding: 0;">
                        <img src="../images-aiholo/Icons/Yellow/Trash bin.svg" alt="Clear" style="width: 70px; height: auto;">
                    </button>
                </div>
                
                <!-- Other action buttons -->
                <div class="d-flex flex-column align-items-center">
                    <span style="font-size: 14px; margin-bottom: 2px;">Explain exhibit</span>
                    <button id="explainerBtn" class="btn btn-primary" style="background: none; border: none; padding: 0;" title="Explain Exhibit">
                        <img src="../images-aiholo/Icons/Yellow/Explain.svg" alt="Explain This" style="width: 70px; height: auto;">
                    </button>
                </div>
                <div class="d-flex flex-column align-items-center">
                    <span style="font-size: 14px; margin-bottom: 2px;">Mirror me</span>
                    <button id="mirrorMeBtn" class="btn btn-primary" style="background: none; border: none; padding: 0;" title="Mirror Me">
                        <img src="../images-aiholo/Icons/Yellow/Face id.svg" alt="Mirror Me" style="width: 70px; height: auto;">
                    </button>
                </div>
                <div class="d-flex flex-column align-items-center">
                    <span style="font-size: 14px; margin-bottom: 2px;">Camera</span>
                    <button id="cameraBtn" class="btn btn-primary" style="background: none; border: none; padding: 0;" title="Vision AI Camera">
                        <img src="../images-aiholo/Icons/Yellow/Camera.png" alt="Camera" style="width: 70px; height: auto;">
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ‚úÖ Transcription field (editable) -->
<textarea id="transcription" placeholder="Your speech will appear here. You can edit it before sending."></textarea>
<p id="responseMessage"></p>

<hr style="border-top: 2px solid #CC5500; margin: 20px 0;">
<br>

<!-- Settings Toggle Button -->
<div style="margin: 10px 0;">
    <button id="settingsToggle" onclick="toggleSettings()" style="background: #CC5500; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
        ‚ñ∂ Settings...
    </button>
</div>

<!-- Settings organized in columns (hidden by default) -->
<div id="settingsSection" style="display: none; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 16px; font-size: 0.85rem; color: #A0A0A0;">
    
    <!-- Column 1: LLM & History Settings -->
    <div>
        <div style="margin-bottom: 12px;">
            <label for="llmModelSelect" style="display: block; margin-bottom: 4px;">Default LLM:</label>
            <select id="llmModelSelect" style="width: 100%; background: #2A2F2F; color: #F1EFED; border: 1px solid #444; border-radius: 4px; padding: 6px 8px;">
                <option value="gpt-4">GPT-4 (default)</option>
            </select>
        </div>
        <div style="margin-bottom: 12px;">
            <label for="conversationHistorySelect" style="display: block; margin-bottom: 4px;">Conversation history:</label>
            <select id="conversationHistorySelect" style="width: 100%; background: #2A2F2F; color: #F1EFED; border: 1px solid #444; border-radius: 4px; padding: 6px 8px;">
                <option value="off" selected>Don't keep history</option>
                <option value="on">Keep history</option>
            </select>
        </div>
        <div style="margin-bottom: 12px;">
            <label for="docSimilarityThreshold" style="display: block; margin-bottom: 4px;">Doc Similarity Threshold:</label>
            <input type="number" id="docSimilarityThreshold" min="0.0" max="1.0" step="0.05" value="0.90" 
                   style="width: 100%; background: #2A2F2F; color: #F1EFED; border: 1px solid #444; border-radius: 4px; padding: 6px 8px;">
            <span style="font-size: 0.7rem; color: #808080; display: block; margin-top: 2px;">Lower = more strict (0.0-1.0)</span>
        </div>
    </div>

    <!-- Column 2: Voice & TTS Settings -->
    <div>
        <div style="margin-bottom: 12px;">
            <label for="voiceNameSelect" style="display: block; margin-bottom: 4px;">Voice Name:</label>
            <select id="voiceNameSelect" style="width: 100%; background: #2A2F2F; color: #F1EFED; border: 1px solid #444; border-radius: 4px; padding: 6px 8px;">
                <option value="en-US-Chirp3-HD-Aoede">en-US-Chirp3-HD-Aoede</option>
            </select>
        </div>
        <div style="margin-bottom: 12px;">
            <label for="ttsModeSelect" style="display: block; margin-bottom: 4px;">TTS engine &amp; quality:</label>
            <select id="ttsModeSelect" style="width: 100%; background: #2A2F2F; color: #F1EFED; border: 1px solid #444; border-radius: 4px; padding: 6px 8px;">
                <option value="GCP">Google Cloud TTS</option>
            </select>
        </div>
    </div>

    <!-- Column 3: Dual Audio Configuration -->
    <div>
        <div style="margin-bottom: 12px;">
            <label style="display: block; margin-bottom: 4px;">
                <input type="checkbox" id="enableDualAudioOutput" th:checked="${enableDualAudioOutput}" style="margin-right: 6px;">
                Enable Dual Audio Output
            </label>
        </div>
        <div style="margin-bottom: 8px;">
            <label for="audioDelayInput" style="display: block; margin-bottom: 4px; font-size: 0.8rem;">Audio delay (ms):</label>
            <input type="number" id="audioDelayInput" min="0" max="5000" step="50" value="500" 
                   style="width: 100%; background: #2A2F2F; color: #F1EFED; border: 1px solid #444; border-radius: 4px; padding: 6px 8px;">
            <span style="font-size: 0.7rem; color: #808080; display: block; margin-top: 2px;">Between dual outputs</span>
        </div>
        <div style="margin-bottom: 6px;">
            <label for="audioDeviceA" style="display: block; margin-bottom: 2px; font-size: 0.75rem;">Stream A ‚Üí Unreal:</label>
            <input type="text" id="audioDeviceA" th:value="${audioDeviceA}" placeholder="CABLE Input" 
                   style="width: 100%; background: #2A2F2F; color: #F1EFED; border: 1px solid #444; border-radius: 4px; padding: 4px 6px; font-size: 0.75rem;">
        </div>
        <div>
            <label for="audioDeviceB" style="display: block; margin-bottom: 2px; font-size: 0.75rem;">Stream B ‚Üí Zoom:</label>
            <input type="text" id="audioDeviceB" th:value="${audioDeviceB}" placeholder="Speakers (Voicemeeter)" 
                   style="width: 100%; background: #2A2F2F; color: #F1EFED; border: 1px solid #444; border-radius: 4px; padding: 4px 6px; font-size: 0.75rem;">
        </div>
    </div>
</div>

<script>
    // Toggle settings section visibility
    function toggleSettings() {
        const section = document.getElementById("settingsSection");
        const button = document.getElementById("settingsToggle");
        if (section.style.display === "none") {
            section.style.display = "grid";
            button.innerHTML = "‚ñº Settings...";
        } else {
            section.style.display = "none";
            button.innerHTML = "‚ñ∂ Settings...";
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        console.log("Speech Recognition Language Code:", languageCodeSTT);
        let recognition;
        let isListening = false;
        let transcriptBuffer = "";
        let conversationHistory = [];
        // Global flag to control whether conversation history is preserved
        let historyEnabled = false;
    initVoiceDropdown();
    initTtsDropdown();
    initAudioDelayInput();
    initDualAudioInputs();
    initLlmDropdown();
    initDocSimilarityThreshold();
        // Attach listener to history dropdown
        const historySelect = document.getElementById("conversationHistorySelect");
        if (historySelect) {
            historySelect.addEventListener("change", (event) => {
                historyEnabled = event.target.value === "on";
                console.log("Conversation history", historyEnabled ? "enabled" : "disabled");
            });
        }

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = languageCodeSTT;

            recognition.onstart = () => {
                console.log("üé§ Speech recognition started with language:", recognition.lang);
                document.getElementById("startBtn").disabled = true;
                document.getElementById("stopSendBtn").disabled = false;
                transcriptBuffer = "";
                isListening = true;
            };

            recognition.onend = () => {
                console.log("üõë Speech recognition stopped.");
                document.getElementById("startBtn").disabled = false;
                document.getElementById("stopSendBtn").disabled = true;
                isListening = false;
            };

            recognition.onerror = (event) => {
                console.error("‚ö†Ô∏è Error:", event.error);
            };

            recognition.onresult = (event) => {
                let interimTranscript = "";
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        transcriptBuffer += event.results[i][0].transcript + " ";
                    } else {
                        interimTranscript += event.results[i][0].transcript + " ";
                    }
                }
                console.log("Final Transcript Buffer:", transcriptBuffer.trim());
                console.log("Interim Transcript:", interimTranscript.trim());
                document.getElementById("transcription").value = transcriptBuffer.trim() + " " + interimTranscript.trim();
            };
        } else if (recognition.lang !== "he-IL" && languageCodeSTT === "he-IL") {
            alert("‚ö†Ô∏è Speech Recognition for specified language is not supported in this browser.");
        } else {
            alert("‚ö†Ô∏è Browser does not support Speech Recognition.");
        }

        // Extract send logic to a function
        async function sendTranscript() {
            // Get the text from the textarea (allows user edits)
            const transcriptionText = document.getElementById("transcription").value.trim();
            if (!transcriptionText) {
                alert("‚ö†Ô∏è No text captured. Try sending again.");
                return;
            }

            // Check for "mirror me" command
            if (transcriptionText.toLowerCase() === "mirror me") {
                try {
                    const response = await fetch("[[${aiholoHostUrl}]]/aiholo/set?value=mirrorme", { method: "GET" });
                    if (response.ok) {
                        document.getElementById("responseMessage").innerText = "‚úÖ Switched to 'Mirror Me' mode successfully!";
                    } else {
                        document.getElementById("responseMessage").innerText = "‚ùå Failed to switch to 'Mirror Me' mode.";
                    }
                } catch (error) {
                    document.getElementById("responseMessage").innerText = "‚ùå An error occurred while switching to 'Mirror Me' mode.";
                } finally {
                    transcriptBuffer = "";
                    document.getElementById("transcription").value = "";
                }
                return;
            }


            // Reset conversation history if historyEnabled is turned off
            if (!historyEnabled) {
                conversationHistory = [];
            }
            // Add the current question to history
            conversationHistory.push({ question: transcriptionText });
            // When history is enabled, keep only the last two question/answer pairs
            if (historyEnabled && conversationHistory.length > 2) {
                conversationHistory.shift();
            }

            // Build the conversational context
            let conversationalContext = conversationHistory
                .map((entry, index) => `Q${index + 1}: ${entry.question}${entry.answer ?  `\nA${index + 1}: ${entry.answer}` : ''}`)
                .join('\n');

            const modifiedText = `${conversationalContext}\nQ: ${transcriptionText}`;
            const voiceDropdown = document.getElementById("voiceNameSelect");
            if (voiceDropdown && voiceDropdown.value) {
                voiceName = voiceDropdown.value;
            }
            const footerVoiceInputSend = document.getElementById("footerVoiceName");
            if (footerVoiceInputSend) {
                footerVoiceInputSend.value = voiceName;
            }
            const audio2FaceDropdown = document.getElementById("audio2FaceSelect");
            if (audio2FaceDropdown) {
                audio2FaceEnabled = audio2FaceDropdown.value === "true";
            }
            const footerAudio2FaceInputSend = document.getElementById("footerAudio2Face");
            if (footerAudio2FaceInputSend) {
                footerAudio2FaceInputSend.value = String(audio2FaceEnabled);
            }
            const audioDelayInput = document.getElementById("audioDelayInput");
            if (audioDelayInput) {
                audioDelayMs = parseInt(audioDelayInput.value, 10);
            }
            const apiUrl = `[[${aiholoHostUrl}]]/aiholo/play?question=${encodeURIComponent(modifiedText)}&languageCode=${encodeURIComponent(languageCodeSTT)}&voiceName=${encodeURIComponent(voiceName)}&ttsMode=${encodeURIComponent(ttsMode)}&llmModel=${encodeURIComponent(llmModel)}&audioDelayMs=${encodeURIComponent(audioDelayMs)}&enableDualAudio=${encodeURIComponent(enableDualAudioOutput)}&audioDeviceA=${encodeURIComponent(audioDeviceA)}&audioDeviceB=${encodeURIComponent(audioDeviceB)}`;


            try {
                const response = await fetch(apiUrl, { method: "GET" });
                const result = await response.text();

                conversationHistory[conversationHistory.length - 1].answer = result;

                document.getElementById("responseMessage").innerText = `‚úÖ Response: ${result}`;
            } catch (error) {
                document.getElementById("responseMessage").innerText = "‚ùå Error retrieving response.";
            } finally {
                transcriptBuffer = "";
                document.getElementById("transcription").value = "";
            }
        }

        document.getElementById("clearBtn").addEventListener("click", () => {
            console.log("Clear button clicked!"); // Debugging
            transcriptBuffer = ""; // Clear the transcript buffer
            document.getElementById("transcription").value = ""; // Clear the transcription text field
            document.getElementById("responseMessage").innerText = ""; // Optionally clear the response message
            conversationHistory = []; // Clear the conversation history
        });

        document.getElementById("mirrorMeBtn").addEventListener("click", async () => {
            try {
                const response = await fetch("[[${aiholoHostUrl}]]/aiholo/set?value=mirrorme", { method: "GET" });
                if (response.ok) {
                    alert("‚úÖ Switched to 'Mirror Me' mode successfully!");
                } else {
                    alert("‚ùå Failed to switch to 'Mirror Me' mode.");
                }
            } catch (error) {
                console.error("Error switching to 'Mirror Me' mode:", error);
                alert("‚ùå An error occurred while switching to 'Mirror Me' mode.");
            }
        });

        document.getElementById("explainerBtn").addEventListener("click", async () => {
            try {
                // Include dual audio configuration parameters
                const explainerUrl = `[[${aiholoHostUrl}]]/aiholo/explainer?enableDualAudio=${encodeURIComponent(enableDualAudioOutput)}&audioDeviceA=${encodeURIComponent(audioDeviceA)}&audioDeviceB=${encodeURIComponent(audioDeviceB)}&audioDelayMs=${encodeURIComponent(audioDelayMs)}`;
                console.log("Calling explainer with URL:", explainerUrl);
                const response = await fetch(explainerUrl, { method: "GET" });
                if (response.ok) {
                    alert("‚úÖ Explainer mode activated successfully!");
                } else {
                    alert("‚ùå Failed to activate explainer mode.");
                }
            } catch (error) {
                console.error("Error activating explainer mode:", error);
                alert("‚ùå An error occurred while activating explainer mode.");
            }
        });

        // Single Button Mode toggle logic
        let singleBtnModeState = false; // false = ready to start, true = ready to stop

        const singleBtnMode = document.getElementById("singleBtnMode");
        const singleBtnIcon = document.getElementById("singleBtnIcon");
        const micIcon = "../images-aiholo/Icons/Yellow/Microphone.svg";
        const stopIcon = "../images-aiholo/Icons/Yellow/Stop recording.svg";

        // Get audio elements
        const listeningSound = document.getElementById("listeningSound");
        const sendingSound = document.getElementById("sendingSound");

        // Mouse down/up logic for press-to-talk
        singleBtnMode.addEventListener("mousedown", () => {
            if (!isListening && recognition) {
                recognition.start();
                singleBtnIcon.src = stopIcon;
                singleBtnMode.disabled = false;
                listeningSound.currentTime = 0;
                listeningSound.play();
            }
        });

        singleBtnMode.addEventListener("mouseup", () => {
            if (isListening && recognition) {
                recognition.stop();
                singleBtnMode.disabled = true; // Prevent double triggers
                sendingSound.currentTime = 0;
                sendingSound.play();
            }
        });

        // Also support touch devices
        singleBtnMode.addEventListener("touchstart", (e) => {
            e.preventDefault();
            if (!isListening && recognition) {
                recognition.start();
                singleBtnIcon.src = stopIcon;
                singleBtnMode.disabled = false;
                listeningSound.currentTime = 0;
                listeningSound.play();
            }
        });

        singleBtnMode.addEventListener("touchend", (e) => {
            e.preventDefault();
            if (isListening && recognition) {
                recognition.stop();
                singleBtnMode.disabled = true;
                sendingSound.currentTime = 0;
                sendingSound.play();
            }
        });

        if (recognition) {
            recognition.onstart = () => {
                singleBtnIcon.src = stopIcon;
                isListening = true;
                singleBtnMode.disabled = false;
            };
            recognition.onend = async () => {
                singleBtnIcon.src = micIcon;
                isListening = false;
                singleBtnMode.disabled = false;
                await sendTranscript();
                transcriptBuffer = "";
                document.getElementById("transcription").value = "";
            };
        }
    });
</script>

<audio id="listeningSound" src="../audio-aiholo/listening-chime.mp4" preload="auto"></audio>
<audio id="sendingSound" src="../audio-aiholo/sendingquestion-chime.mp4" preload="auto"></audio>

<!--<div class="bottom-links">-->
<br>
<div>
    <a href="https://bit.ly/3AdlZ1d" target="_blank">
        <img src="../images-aiholo/aiholo-architecture-mutlicloud.png" alt="ai holo arch" style="width: 1400px; height: auto;">
    </a>
    <br>
    <br>
    <a href="https://bit.ly/3AdlZ1d" target="_blank">
        <img src="../images-aiholo/bit.ly_interactive-ai-holograms.png" alt="aiholo repos" style="width: 400px; height: auto;">
    </a>
</div>
<br>
<hr style="border-top: 2px solid #CC5500; margin: 20px 0;">
<br>
<div class="footer">
    <form id="footerSayForm" class="input-group" action="[[${aiholoHostUrl}]]/aiholo/playarbitrary" method="GET">
        <input type="text" id="speechInput" name="answer" class="form-control" placeholder="Type something to say directly..." required>
        <input type="hidden" id="footerLanguageCode" name="languageCode" value="" />
        <input type="hidden" id="footerVoiceName" name="voiceName" value="" />
        <input type="hidden" id="footerTtsMode" name="ttsMode" value="" />
        <input type="hidden" id="footerAudio2Face" name="audio2Face" value="" />
        <div class="input-group-append">
            <button type="submit" style="background:none; border:none; padding:0;" title="Submit">
                <img src="../images-aiholo/Icons/Yellow/Stop recording.svg" style="cursor:pointer;">
            </button>
            <button type="submit" class="btn btn-primary" style="margin-left: 10px;">Say It</button>
        </div>
    </form>
</div>
<script>
    // Set the languageCode and voiceName from the JS variables used elsewhere
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("footerLanguageCode").value = typeof languageCodeSTT !== "undefined" ? languageCodeSTT : "en-US";
        document.getElementById("footerVoiceName").value = typeof voiceName !== "undefined" ? voiceName : "en-US-Wavenet-A";
    document.getElementById("footerTtsMode").value = typeof ttsMode !== "undefined" ? ttsMode : "GCP";
        document.getElementById("footerAudio2Face").value = String(audio2FaceEnabled);

        document.getElementById("footerSayForm").addEventListener("submit", function (e) {
            e.preventDefault();
            const answer = document.getElementById("speechInput").value;
            const languageCode = document.getElementById("footerLanguageCode").value;
            const voiceName = document.getElementById("footerVoiceName").value;
            const selectedTtsMode = document.getElementById("footerTtsMode").value;
            const audio2Face = document.getElementById("footerAudio2Face").value;
            const delayMs = audioDelayMs;
            const fileName = "footer.wav";
            const url = `[[${aiholoHostUrl}]]/aiholo/playarbitrary?fileName=${encodeURIComponent(fileName)}&answer=${encodeURIComponent(answer)}&languageCode=${encodeURIComponent(languageCode)}&voiceName=${encodeURIComponent(voiceName)}&ttsMode=${encodeURIComponent(selectedTtsMode)}&audio2Face=${encodeURIComponent(audio2Face)}&audioDelayMs=${encodeURIComponent(delayMs)}`;
            window.open(url, "aiholoFooterSay", "width=600,height=400");
        });
    });
</script>

<!-- Agent Management Section -->
<div style="max-width: 800px; margin: 40px auto; padding: 20px; border: 1px solid #444; border-radius: 8px; background-color: #1A1F1F;">
    <h3 style="color: #F1EFED; margin-bottom: 20px;">Agent Management</h3>
    
    <!-- Current Agents List -->
    <div style="margin-bottom: 30px;">
        <h4 style="color: #F1EFED; margin-bottom: 15px;">Current Agents:</h4>
        <ul id="agentList" style="list-style: none; padding: 0; color: #F1EFED;">
            <li style="padding: 8px; margin-bottom: 5px; background-color: #2A2F2F; border-radius: 4px;">üë§ DigitalTwin - Yoda</li>
            <li style="padding: 8px; margin-bottom: 5px; background-color: #2A2F2F; border-radius: 4px;">üëÅÔ∏è VisionAI - Ada</li>
            <li style="padding: 8px; margin-bottom: 5px; background-color: #2A2F2F; border-radius: 4px;">üìö OracleDoc - Adrian</li>
            <li style="padding: 8px; margin-bottom: 5px; background-color: #2A2F2F; border-radius: 4px;">üí∞ Financial - Adrian</li>
            <li style="padding: 8px; margin-bottom: 5px; background-color: #2A2F2F; border-radius: 4px;">üéÆ Gamer - Trinity</li>
            <li style="padding: 8px; margin-bottom: 5px; background-color: #2A2F2F; border-radius: 4px;">ü§ñ DirectLLM - Akira</li>
        </ul>
    </div>
    
    <!-- Add New Agent Form -->
    <div style="margin-bottom: 30px; padding: 20px; background-color: #2A2F2F; border-radius: 6px;">
        <h4 style="color: #F1EFED; margin-bottom: 15px;">Add New Agent</h4>
        <form id="addAgentForm" style="display: flex; flex-direction: column; gap: 15px;">
            <div>
                <label for="agentName" style="display: block; margin-bottom: 5px; color: #F1EFED;">Agent Name:</label>
                <input type="text" id="agentName" name="agentName" required 
                       style="width: 100%; padding: 8px; background: #1A1F1F; color: #F1EFED; border: 1px solid #444; border-radius: 4px;"
                       placeholder="e.g., TravelGuide, MedicalAdvisor">
            </div>
            <div>
                <label for="metahumanName" style="display: block; margin-bottom: 5px; color: #F1EFED;">Unreal Metahuman:</label>
                <select id="metahumanName" name="metahumanName" required
                        style="width: 100%; padding: 8px; background: #1A1F1F; color: #F1EFED; border: 1px solid #444; border-radius: 4px;">
                    <option value="">-- Select Metahuman --</option>
                    <optgroup label="Custom Characters">
                        <option value="Trinity">Trinity</option>
                        <option value="Yoda">Yoda</option>
                    </optgroup>
                    <optgroup label="Unreal 5.6 Default Metahumans">
                        <option value="Ada">Ada</option>
                        <option value="Aarav">Aarav</option>
                        <option value="Aaliyah">Aaliyah</option>
                        <option value="Abby">Abby</option>
                        <option value="Ace">Ace</option>
                        <option value="Addison">Addison</option>
                        <option value="Adrian">Adrian</option>
                        <option value="Adriana">Adriana</option>
                        <option value="Aiden">Aiden</option>
                        <option value="Akira">Akira</option>
                        <option value="Alex">Alex</option>
                        <option value="Alexander">Alexander</option>
                        <option value="Alexa">Alexa</option>
                        <option value="Alice">Alice</option>
                        <option value="Alicia">Alicia</option>
                        <option value="Amara">Amara</option>
                        <option value="Amber">Amber</option>
                        <option value="Amelia">Amelia</option>
                        <option value="Amy">Amy</option>
                        <option value="Andre">Andre</option>
                        <option value="Andrea">Andrea</option>
                        <option value="Andrew">Andrew</option>
                        <option value="Angela">Angela</option>
                        <option value="Angelica">Angelica</option>
                        <option value="Anna">Anna</option>
                        <option value="Anthony">Anthony</option>
                        <option value="Antonio">Antonio</option>
                        <option value="Aria">Aria</option>
                        <option value="Ariana">Ariana</option>
                        <option value="Arthur">Arthur</option>
                        <option value="Ashley">Ashley</option>
                        <option value="Asher">Asher</option>
                        <option value="Aubrey">Aubrey</option>
                        <option value="Aurora">Aurora</option>
                        <option value="Austin">Austin</option>
                        <option value="Ava">Ava</option>
                        <option value="Avery">Avery</option>
                    </optgroup>
                </select>
            </div>
            <button type="submit" class="btn btn-primary" style="padding: 10px 20px; background-color: #444; border: 1px solid #666; color: #F1EFED; border-radius: 4px; cursor: pointer;">
                Add Agent
            </button>
        </form>
    </div>
    
    <!-- Upload Media for Vector Search -->
    <div style="padding: 20px; background-color: #2A2F2F; border-radius: 6px;">
        <h4 style="color: #F1EFED; margin-bottom: 15px;">Upload Media for Agent(s) to Use for Vector Searches</h4>
        <form id="uploadMediaForm" enctype="multipart/form-data" style="display: flex; flex-direction: column; gap: 15px;">
            <div>
                <label for="mediaFile" style="display: block; margin-bottom: 5px; color: #F1EFED;">Select Media File:</label>
                <input type="file" id="mediaFile" name="mediaFile" required
                       accept=".pdf,.doc,.docx,.txt,.json,.xml,.csv"
                       style="width: 100%; padding: 8px; background: #1A1F1F; color: #F1EFED; border: 1px solid #444; border-radius: 4px;">
                <small style="color: #808080; display: block; margin-top: 5px;">Supported formats: PDF, DOC, DOCX, TXT, JSON, XML, CSV</small>
            </div>
            <div>
                <label style="display: block; margin-bottom: 8px; color: #F1EFED;">Select Agent(s):</label>
                <div id="agentCheckboxes" style="display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; padding: 10px; background: #1A1F1F; border: 1px solid #444; border-radius: 4px;">
                    <label style="color: #F1EFED; cursor: pointer;">
                        <input type="checkbox" name="agents" value="DigitalTwin" style="margin-right: 8px;">
                        DigitalTwin
                    </label>
                    <label style="color: #F1EFED; cursor: pointer;">
                        <input type="checkbox" name="agents" value="VisionAI" style="margin-right: 8px;">
                        VisionAI
                    </label>
                    <label style="color: #F1EFED; cursor: pointer;">
                        <input type="checkbox" name="agents" value="OracleDoc" style="margin-right: 8px;">
                        OracleDoc
                    </label>
                    <label style="color: #F1EFED; cursor: pointer;">
                        <input type="checkbox" name="agents" value="Financial" style="margin-right: 8px;">
                        Financial
                    </label>
                    <label style="color: #F1EFED; cursor: pointer;">
                        <input type="checkbox" name="agents" value="Gamer" style="margin-right: 8px;">
                        Gamer
                    </label>
                </div>
            </div>
            <button type="submit" class="btn btn-primary" style="padding: 10px 20px; background-color: #444; border: 1px solid #666; color: #F1EFED; border-radius: 4px; cursor: pointer;">
                Upload & Process
            </button>
        </form>
    </div>
</div>

<script>
    // Add Agent Form Handler
    document.getElementById("addAgentForm").addEventListener("submit", async function(e) {
        e.preventDefault();
        
        const agentName = document.getElementById("agentName").value;
        const metahumanName = document.getElementById("metahumanName").value;
        
        try {
            const response = await fetch(`[[${aiholoHostUrl}]]/aiholo/agent/add`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ agentName, metahumanName })
            });
            
            if (response.ok) {
                alert(`‚úÖ Agent "${agentName}" with Metahuman "${metahumanName}" added successfully!`);
                document.getElementById("addAgentForm").reset();
                // Add to the list
                const agentList = document.getElementById("agentList");
                const li = document.createElement("li");
                li.style.cssText = "padding: 8px; margin-bottom: 5px; background-color: #2A2F2F; border-radius: 4px;";
                li.textContent = `üÜï ${agentName} - ${metahumanName}`;
                agentList.appendChild(li);
                
                // Add to checkboxes
                const checkboxContainer = document.getElementById("agentCheckboxes");
                const label = document.createElement("label");
                label.style.cssText = "color: #F1EFED; cursor: pointer;";
                label.innerHTML = `<input type="checkbox" name="agents" value="${agentName}" style="margin-right: 8px;">${agentName}`;
                checkboxContainer.appendChild(label);
            } else {
                const error = await response.text();
                alert(`‚ùå Failed to add agent: ${error}`);
            }
        } catch (error) {
            console.error("Error adding agent:", error);
            alert("‚ùå An error occurred while adding the agent.");
        }
    });
    
    // Upload Media Form Handler
    document.getElementById("uploadMediaForm").addEventListener("submit", async function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById("mediaFile");
        const selectedAgents = Array.from(document.querySelectorAll('input[name="agents"]:checked')).map(cb => cb.value);
        
        if (selectedAgents.length === 0) {
            alert("‚ö†Ô∏è Please select at least one agent.");
            return;
        }
        
        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        formData.append("agents", selectedAgents.join(","));
        
        try {
            const response = await fetch(`[[${aiholoHostUrl}]]/aiholo/media/upload`, {
                method: "POST",
                body: formData
            });
            
            if (response.ok) {
                const result = await response.json();
                alert(`‚úÖ Media uploaded successfully!\n\nProcessed for agents: ${selectedAgents.join(", ")}\n\nVectors created: ${result.vectorCount || "N/A"}`);
                document.getElementById("uploadMediaForm").reset();
            } else {
                const error = await response.text();
                alert(`‚ùå Failed to upload media: ${error}`);
            }
        } catch (error) {
            console.error("Error uploading media:", error);
            alert("‚ùå An error occurred while uploading the media.");
        }
    });
</script>

<!-- Camera Modal for Vision AI -->
<div id="cameraModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8);">
    <div style="position: relative; margin: 50px auto; max-width: 800px; background-color: #2A2F2F; padding: 20px; border-radius: 8px;">
        <span id="closeCamera" style="position: absolute; top: 10px; right: 20px; color: #F1EFED; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h3 style="color: #F1EFED; text-align: center; margin-bottom: 20px;">Vision AI Camera</h3>
        
        <div style="text-align: center;">
            <video id="cameraVideo" autoplay style="width: 100%; max-width: 640px; border: 2px solid #444; border-radius: 4px; display: none;"></video>
            <canvas id="cameraCanvas" style="width: 100%; max-width: 640px; border: 2px solid #444; border-radius: 4px; display: none;"></canvas>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button id="captureBtn" class="btn btn-primary" style="padding: 10px 20px; background-color: #444; border: 1px solid #666; color: #F1EFED; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                üì∏ Capture Image
            </button>
            <button id="analyzeBtn" class="btn btn-primary" style="padding: 10px 20px; background-color: #444; border: 1px solid #666; color: #F1EFED; border-radius: 4px; cursor: pointer; display: none;">
                üîç Analyze
            </button>
            <button id="retakeBtn" class="btn btn-primary" style="padding: 10px 20px; background-color: #444; border: 1px solid #666; color: #F1EFED; border-radius: 4px; cursor: pointer; margin-left: 10px; display: none;">
                üîÑ Retake
            </button>
        </div>
        
        <div id="visionResult" style="margin-top: 20px; padding: 15px; background-color: #1A1F1F; border: 1px solid #444; border-radius: 4px; color: #F1EFED; display: none;">
            <h4 style="color: #F1EFED;">Analysis Result:</h4>
            <p id="visionResultText"></p>
        </div>
    </div>
</div>

<script>
    let cameraStream = null;
    let capturedImageData = null;
    
    // Camera button click
    document.getElementById("cameraBtn").addEventListener("click", async () => {
        document.getElementById("cameraModal").style.display = "block";
        document.getElementById("cameraVideo").style.display = "block";
        document.getElementById("cameraCanvas").style.display = "none";
        document.getElementById("captureBtn").style.display = "inline-block";
        document.getElementById("analyzeBtn").style.display = "none";
        document.getElementById("retakeBtn").style.display = "none";
        document.getElementById("visionResult").style.display = "none";
        
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
            document.getElementById("cameraVideo").srcObject = cameraStream;
        } catch (error) {
            console.error("Error accessing camera:", error);
            alert("‚ùå Could not access camera: " + error.message);
        }
    });
    
    // Close camera
    document.getElementById("closeCamera").addEventListener("click", () => {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }
        document.getElementById("cameraModal").style.display = "none";
    });
    
    // Capture image
    document.getElementById("captureBtn").addEventListener("click", () => {
        const video = document.getElementById("cameraVideo");
        const canvas = document.getElementById("cameraCanvas");
        const context = canvas.getContext("2d");
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        capturedImageData = canvas.toDataURL("image/jpeg", 0.8);
        
        // Stop camera and show captured image
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }
        
        video.style.display = "none";
        canvas.style.display = "block";
        document.getElementById("captureBtn").style.display = "none";
        document.getElementById("analyzeBtn").style.display = "inline-block";
        document.getElementById("retakeBtn").style.display = "inline-block";
    });
    
    // Retake image
    document.getElementById("retakeBtn").addEventListener("click", async () => {
        document.getElementById("cameraVideo").style.display = "block";
        document.getElementById("cameraCanvas").style.display = "none";
        document.getElementById("captureBtn").style.display = "inline-block";
        document.getElementById("analyzeBtn").style.display = "none";
        document.getElementById("retakeBtn").style.display = "none";
        document.getElementById("visionResult").style.display = "none";
        
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
            document.getElementById("cameraVideo").srcObject = cameraStream;
        } catch (error) {
            console.error("Error accessing camera:", error);
            alert("‚ùå Could not access camera: " + error.message);
        }
    });
    
    // Analyze image
    document.getElementById("analyzeBtn").addEventListener("click", async () => {
        if (!capturedImageData) {
            alert("‚ö†Ô∏è No image captured");
            return;
        }
        
        document.getElementById("analyzeBtn").disabled = true;
        document.getElementById("analyzeBtn").textContent = "üîÑ Analyzing...";
        
        try {
            // Remove data:image/jpeg;base64, prefix
            const base64Image = capturedImageData.split(',')[1];
            
            const response = await fetch(`[[${aiholoHostUrl}]]/aiholo/vision/analyze`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ imageData: base64Image })
            });
            
            if (response.ok) {
                const result = await response.text();
                document.getElementById("visionResultText").textContent = result;
                document.getElementById("visionResult").style.display = "block";
            } else {
                const error = await response.text();
                alert(`‚ùå Analysis failed: ${error}`);
            }
        } catch (error) {
            console.error("Error analyzing image:", error);
            alert("‚ùå An error occurred while analyzing the image.");
        } finally {
            document.getElementById("analyzeBtn").disabled = false;
            document.getElementById("analyzeBtn").textContent = "üîç Analyze";
        }
    });
</script>

</body>
</html>
