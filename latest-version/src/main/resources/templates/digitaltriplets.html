<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Triplet Dashboard - Interactive AI Holograms</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.0/css/bootstrap.min.css" crossorigin="anonymous">
    <!-- Leaflet for mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <!-- Three.js for 3D rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- FBX Loader for Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/FBXLoader.js"></script>
    <!-- Required dependencies for FBX loading -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/fflate.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #2A2F2F;
            color: #F1EFED;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        .dashboard-container {
            display: grid;
            grid-template-rows: 60px 1fr 1fr;
            grid-template-columns: 1fr 1fr 1fr;
            height: 100vh;
            gap: 2px;
            background-color: #1A1F1F;
        }
        
        .dashboard-header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #CC5500 0%, #B8490C 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .grid-panel {
            background: #2A2F2F;
            border: 1px solid #CC5500;
            overflow: auto;
            position: relative;
        }
        
        .panel-title {
            background: #CC5500;
            color: white;
            padding: 8px 15px;
            font-weight: bold;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 2px solid #B8490C;
        }
        
        .panel-content {
            padding: 15px;
        }
        
        /* Factory panel specific styles */
        #factory-panel {
            grid-row: 2;
            grid-column: 1;
        }
        
        #factory-panel h1, #factory-panel h2, #factory-panel h3, 
        #factory-panel h4, #factory-panel h5, #factory-panel p, 
        #factory-panel label {
            color: #F1EFED;
        }
        
        #factory-panel .status-panel {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #CC5500;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        #factory-panel .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        #factory-panel .status-online {
            background-color: #28a745;
        }
        
        #factory-panel .status-offline {
            background-color: #dc3545;
        }
        
        #factory-panel .checkbox-group {
            margin: 15px 0;
        }
        
        #factory-panel .checkbox-group label {
            display: block;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        #factory-panel .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        #factory-panel .btn-activate {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
            margin: 5px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        #factory-panel .btn-activate:hover {
            background-color: #c82333;
        }
        
        #factory-panel .btn-restore {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
            margin: 5px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        #factory-panel .btn-restore:hover {
            background-color: #218838;
        }
        
        #factory-panel .status-readout {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #00ff00;
            padding: 12px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 12px;
        }
        
        /* Twitch panel specific styles */
        #twitch-panel {
            grid-row: 2;
            grid-column: 2;
        }
        
        #twitch-panel iframe {
            width: 100%;
            height: calc(100% - 40px);
            border: none;
        }
        
        /* 3D Digital Twin panel specific styles */
        #digitaltwin-panel {
            grid-row: 2;
            grid-column: 3;
        }
        
        #digitaltwin-panel .panel-content {
            padding: 10px;
            height: calc(100% - 40px);
        }
        
        /* Langflow panel specific styles */
        #langflow-panel {
            grid-row: 3;
            grid-column: 1;
        }
        
        #langflow-panel iframe {
            width: 100%;
            height: calc(100% - 40px);
            border: none;
        }
        
        /* Video panel specific styles */
        #video-panel {
            grid-row: 3;
            grid-column: 2;
        }
        
        /* Map panel specific styles */
        #map-panel {
            grid-row: 3;
            grid-column: 3;
        }
        
        #mapContainer {
            background: #1A1F1F;
        }
        
        /* Placeholder panels */
        .placeholder-panel {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 18px;
            background: #1A1F1F;
        }
    </style>
</head>
<body>

<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        üéØ Digital Triplet Dashboard - Oracle Database Spatial AI Agents
    </div>
    
    <!-- Top Left: Factory Dashboard -->
    <div id="factory-panel" class="grid-panel">
        <div class="panel-title">üè≠ Factory Operations Monitoring & Control</div>
        <div class="panel-content">
            <div class="row">
                <!-- Operations Monitoring -->
                <div class="col-md-6">
                    <h5 style="color: #CC5500; margin-bottom: 15px;">Operations Observability</h5>
                    <div class="status-panel">
                        <h6>System Status Overview</h6>
                        
                        <div class="status-readout">
                            <div style="margin-bottom: 10px;">
                                <strong>CONVEYER BELT STATUS:</strong><br>
                                <span id="conveyerStatus">
                                    <span class="status-indicator status-online"></span>
                                    OPERATIONAL - Speed: 2.3 m/s | Load: 87% | Temp: 42¬∞C
                                </span>
                            </div>
                            
                            <div>
                                <strong>ROUTE STATUS:</strong><br>
                                <span id="routeStatus">
                                    <span class="status-indicator status-online"></span>
                                    ALL CLEAR - Traffic: Normal | Weather: Clear | ETA: On-time
                                </span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 10px; font-size: 11px;">
                            <small>Last Updated: <span id="lastUpdated"></span></small>
                        </div>
                        
                        <div class="control-buttons" style="margin-top: 15px;">
                            <button id="restoreSystem" class="btn-restore">
                                ‚úÖ Restore System
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Fault Simulation -->
                <div class="col-md-6">
                    <h5 style="color: #CC5500; margin-bottom: 15px;">Simulate System Faults</h5>
                    <div class="status-panel">
                        <h6>Fault Simulation Controls</h6>
                        
                        <div style="margin-bottom: 15px;">
                            <button id="roadDamageBtn" class="btn-activate" style="width: 100%; padding: 12px; font-size: 14px; margin-bottom: 10px;">
                                üöß Simulate Road Damage (Potholes/Sinkhole)
                            </button>
                            <p style="font-size: 11px; color: #888; margin: 5px 0 0 0;">
                                Triggers video analysis in Phyll Live Feed panel
                            </p>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button id="conveyerFaultBtn" class="btn-activate" style="width: 100%; padding: 12px; font-size: 14px;">
                                ‚öôÔ∏è Simulate Conveyer Belt Failure
                            </button>
                            <p style="font-size: 11px; margin-top: 5px; color: #ccc;"><em>Activates 3D model and plots supplier route on map</em></p>
                        </div>
                        
                        <!-- Inventory Approval Section -->
                        <div id="inventoryApproval" style="display: none; margin-top: 15px; padding: 15px; background: rgba(76, 175, 80, 0.15); border: 1px solid #4caf50; border-radius: 5px;">
                            <p style="margin: 0 0 10px 0; font-size: 12px; color: #4caf50;">
                                ‚úÖ <strong>Part Available in Inventory</strong>
                            </p>
                            <p style="margin: 0 0 12px 0; font-size: 11px; color: #ccc;">
                                Conveyor belt replacement part (Model CB-2000) is in stock.<br>
                                Route to nearest supplier determined and plotted on map.<br>
                                Ready for installation.
                            </p>
                            <button id="approveReplacementBtn" class="btn-activate" style="width: 100%; padding: 10px; font-size: 13px; background: #4caf50; border-color: #4caf50;">
                                ‚úÖ Approve Replacement
                            </button>
                        </div>
                        
                        <div id="faultStatus" style="margin-top: 15px; font-style: italic; font-size: 12px;">
                            No active faults - System operating normally
                        </div>
                        
                        <!-- API Results -->
                        <div id="apiResults" style="margin-top: 15px; display: none;">
                            <h6>Spatial Analysis Results:</h6>
                            <div id="apiResultsContent" style="background: #f8f9fa; color: #212529; padding: 10px; border-radius: 5px; font-family: Arial, sans-serif; font-size: 11px; max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6;">
                            </div>
                            <div style="margin-top: 10px; text-align: center;">
                                <button id="approveRepair" class="btn" style="background-color: #ffc107; border-color: #ffc107; color: #212529; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer;">
                                    üîß Approve Repair Work Order
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Top Middle: Twitch Stream -->
    <div id="twitch-panel" class="grid-panel">
        <div class="panel-title">üì∫ Omniverse Factory Digital Twin (Live Stream)</div>
        <div style="padding: 10px; text-align: center; height: calc(100% - 40px); display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <p style="margin-bottom: 15px;">Live stream of Unreal/Unity digital twin visualization</p>
            <iframe 
                src="https://player.twitch.tv/?channel=podsofkon&parent=digitaltriplets.org&parent=aiholo.org&parent=localhost&autoplay=false&muted=true"
                height="80%"
                width="95%"
                allowfullscreen>
            </iframe>
            <a href="https://www.twitch.tv/podsofkon" target="_blank" style="color: #9146FF; text-decoration: none; margin-top: 10px; font-weight: bold;">
                üîó Open on Twitch.tv
            </a>
        </div>
    </div>
    
    <!-- Top Right: 3D Digital Twin Viewer -->
    <div id="digitaltwin-panel" class="grid-panel">
        <div class="panel-title">üéÆ 3D ConveyorBelt Digital Twin</div>
        <div class="panel-content">
            <div id="threejs-container-twin" style="width: 100%; height: calc(100% - 100px); background: #000; position: relative; display: none;">
                <div id="loadingMessage3D" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #CC5500; font-size: 16px; font-weight: bold;">
                    üîÑ Initializing 3D Engine...
                </div>
            </div>
            <div id="inactive3DMessage" style="width: 100%; height: calc(100% - 100px); background: #000; display: flex; align-items: center; justify-content: center; flex-direction: column; border: 2px dashed #444; border-radius: 5px;">
                <div style="text-align: center; padding: 20px; max-width: 90%;">
                    <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;">üî∑</div>
                    <p style="color: #CC5500; font-size: 15px; margin: 0 0 10px 0; font-weight: bold;">
                        3D Modeling & Prototyping
                    </p>
                    <p style="color: #aaa; font-size: 12px; margin: 0; line-height: 1.6;">
                        Using Oracle Spatial SDO_Geometry,<br>
                        point cloud, and mesh operations
                    </p>
                </div>
            </div>
            <div class="control-panel" style="margin-top: 10px; display: flex; justify-content: center; flex-wrap: wrap; gap: 5px;">
                <button id="resetView3D" class="btn-activate" style="padding: 5px 10px; font-size: 11px;">üîÑ Reset</button>
                <button id="toggleRotation3D" class="btn-activate" style="padding: 5px 10px; font-size: 11px;">‚ñ∂Ô∏è Play</button>
                <button id="toggleWireframe3D" class="btn-activate" style="padding: 5px 10px; font-size: 11px;">üìê Wireframe</button>
            </div>
        </div>
    </div>
    
    <!-- Bottom Left: Langflow AI -->
    <div id="langflow-panel" class="grid-panel">
        <div class="panel-title">ü§ñ Langflow AI - Agentic Workflow</div>
        <div style="padding: 15px; text-align: center; height: calc(100% - 40px); display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <p style="margin-bottom: 15px; font-size: 13px;">AI workflow engine for intelligent decision-making</p>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <a href="http://141.148.204.74:7860/flow/a6b3b521-b7ac-4e63-955d-4bf15495e2f8" target="_blank" 
                   class="btn-activate" style="padding: 12px 24px; text-decoration: none; display: inline-block; font-size: 13px;">
                    üöÄ Open Langflow Workflow
                </a>
                <a href="http://141.148.204.74:7860/flow/9cf00faa-d420-4f3e-aaeb-9b8904e7b3bd" target="_blank" 
                   class="btn-activate" style="padding: 12px 24px; text-decoration: none; display: inline-block; font-size: 13px;">
                    üè≠ Factory Maintenance Agent - Oracle Spatial
                </a>
                <a href="http://141.148.204.74:7860/flow/9a4de264-e883-4a23-863f-2f00eb45075e" target="_blank" 
                   class="btn-activate" style="padding: 12px 24px; text-decoration: none; display: inline-block; font-size: 13px;">
                    üó∫Ô∏è MCP - Spatial
                </a>
                <a href="http://141.148.204.74:7860/flow/4494cd07-bf86-4d63-9129-d1821bf86bee" target="_blank" 
                   class="btn-activate" style="padding: 12px 24px; text-decoration: none; display: inline-block; font-size: 13px;">
                    üß† Oracle Database AI Optimizer and Toolkit
                </a>
                <a href="http://141.148.204.74:7860/flow/46f1f91f-5d2f-4fca-a558-fc0dffcd73b4" target="_blank" 
                   class="btn-activate" style="padding: 12px 24px; text-decoration: none; display: inline-block; font-size: 13px;">
                    üì° ORDS Calls
                </a>
            </div>
        </div>
    </div>
    
    <!-- Bottom Middle: Video Analysis Feed -->
    <div id="video-panel" class="grid-panel">
        <div class="panel-title">üìπ Phyll Live Feed - Infrastructure Analysis</div>
        <div class="panel-content" style="padding: 10px; height: calc(100% - 40px); overflow-y: auto;">
            <div style="text-align: center; margin-bottom: 10px;">
                <button id="startMonitoringVideo" class="btn-activate" style="padding: 8px 16px; font-size: 12px;">
                    üé• Start Live Monitoring
                </button>
            </div>
            <video id="phyllVideoPanel" style="width: 100%; border: 2px solid #CC5500; border-radius: 5px; background: #000;">
                <source src="images-aiholo/phyllstream.mp4" type="video/mp4">
            </video>
            <div id="analysisResultsPanel" style="margin-top: 10px; background: rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 5px; font-size: 11px;">
                <p><em>Click "Start Live Monitoring" to begin analysis...</em></p>
            </div>
        </div>
    </div>
    
    <!-- Bottom Right: Supply Route Map -->
    <div id="map-panel" class="grid-panel">
        <div class="panel-title">üó∫Ô∏è Supply Route - Oracle Spatial</div>
        <div id="mapContainer" style="width: 100%; height: calc(100% - 40px); position: relative;">
            <div id="mapLoadingMessage" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: rgba(0,0,0,0.8); color: white; padding: 15px; border-radius: 8px; font-size: 14px;">
                üîÑ Loading route data...
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let conveyerFaultActive = false;
    let roadDamageActive = false;
    
    const conveyerFaultBtn = document.getElementById("conveyerFaultBtn");
    const roadDamageBtn = document.getElementById("roadDamageBtn");
    
    // Conveyer Belt Button - activates 3D model, sets fault status, plots route
    if (conveyerFaultBtn) {
        conveyerFaultBtn.addEventListener("click", async function() {
            this.innerHTML = "‚öôÔ∏è Activating Fault...";
            this.disabled = true;
            
            try {
                console.log('=== Conveyor Fault Button clicked ===');
                
                // Set fault status in GetSetController - CRITICAL: This triggers the external fault process
                fetch('/status/simple/set?value=fault', { 
                    method: 'GET' 
                }).then(response => {
                    console.log('‚úÖ Conveyor Fault - Fault status set:', response.ok, response.status);
                    return response.text();
                }).then(text => {
                    console.log('Conveyor Fault API response:', text);
                }).catch(e => {
                    console.error('‚ùå Conveyor Fault API call failed:', e);
                });
                
                // Set conveyer fault as active
                conveyerFaultActive = true;
                updateStatusDisplays();
                updateFaultStatusMessage();
                
                // Show and activate 3D model
                const container3D = document.getElementById('threejs-container-twin');
                const inactiveMsg = document.getElementById('inactive3DMessage');
                if (container3D && inactiveMsg) {
                    container3D.style.display = 'block';
                    inactiveMsg.style.display = 'none';
                    
                    // Initialize 3D viewer if not already done
                    if (!scene3D) {
                        init3DViewer();
                    }
                    
                    // Start rotation
                    isRotating3D = true;
                    const toggleBtn = document.getElementById('toggleRotation3D');
                    if (toggleBtn) toggleBtn.innerHTML = "‚è∏Ô∏è Pause";
                }
                
                // Load and plot conveyor belt replacement route on map
                loadConveyorBeltRoute();
                
                // Visual feedback
                setTimeout(() => {
                    this.innerHTML = "‚öôÔ∏è Conveyer Fault Active";
                    this.disabled = false;
                    
                    // Show inventory approval after actions complete
                    const inventoryApprovalDiv = document.getElementById('inventoryApproval');
                    if (inventoryApprovalDiv) {
                        inventoryApprovalDiv.style.display = 'block';
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Error activating conveyer fault:', error);
                this.innerHTML = "‚öôÔ∏è Simulate Conveyer Belt Failure";
                this.disabled = false;
            }
        });
    }
    
    // Road Damage Button - triggers video playback in panel 5
    if (roadDamageBtn) {
        roadDamageBtn.addEventListener("click", function() {
            const phyllVideoPanel = document.getElementById("phyllVideoPanel");
            const startMonitoringBtn = document.getElementById("startMonitoringVideo");
            const analysisResultsPanel = document.getElementById("analysisResultsPanel");
            
            if (phyllVideoPanel && startMonitoringBtn) {
                // Reset and play video
                phyllVideoPanel.currentTime = 0;
                phyllVideoPanel.play().catch(err => console.log("Video autoplay prevented:", err));
                
                // Update button state
                startMonitoringBtn.disabled = true;
                startMonitoringBtn.innerHTML = "üé• Monitoring Active...";
                
                // Show monitoring message
                analysisResultsPanel.innerHTML = '<p style="font-size: 11px;"><em>Road damage simulation triggered - Video analyzing infrastructure...</em></p>';
                
                // Set road damage as active
                roadDamageActive = true;
                updateStatusDisplays();
                updateFaultStatusMessage();
                
                // Visual feedback
                this.innerHTML = "üöß Simulating...";
                this.disabled = true;
                
                // Re-enable button after video starts
                setTimeout(() => {
                    this.innerHTML = "üöß Simulate Road Damage (Potholes/Sinkhole)";
                    this.disabled = false;
                }, 3000);
            }
        });
    }
    
    function updateTimestamp() {
        const now = new Date();
        document.getElementById("lastUpdated").textContent = now.toLocaleString();
    }
    
    function updateStatusDisplays() {
        const conveyerStatusElement = document.getElementById("conveyerStatus");
        const routeStatusElement = document.getElementById("routeStatus");
        
        if (conveyerFaultActive) {
            conveyerStatusElement.innerHTML = `
                <span class="status-indicator status-offline"></span>
                FAULT DETECTED - Motor malfunction | Speed: 0 m/s | Status: STOPPED
            `;
        } else {
            conveyerStatusElement.innerHTML = `
                <span class="status-indicator status-online"></span>
                OPERATIONAL - Speed: 2.3 m/s | Load: 87% | Temp: 42¬∞C
            `;
        }
        
        if (roadDamageActive) {
            routeStatusElement.innerHTML = `
                <span class="status-indicator status-offline"></span>
                ROUTE DISRUPTED - Sinkhole detected | Detour active | ETA: +45 min delay
            `;
        } else {
            routeStatusElement.innerHTML = `
                <span class="status-indicator status-online"></span>
                ALL CLEAR - Traffic: Normal | Weather: Clear | ETA: On-time
            `;
        }
        
        updateTimestamp();
    }
    
    function updateFaultStatusMessage() {
        const faultStatusElement = document.getElementById("faultStatus");
        const activeFaults = [];
        
        if (conveyerFaultActive) activeFaults.push("Conveyer Belt Failure");
        if (roadDamageActive) activeFaults.push("Road Damage");
        
        if (activeFaults.length === 0) {
            const lastRepaired = localStorage.getItem('lastRepaired');
            if (lastRepaired) {
                faultStatusElement.innerHTML = `No active faults - System operating normally<br><small>Last repaired: ${lastRepaired}</small>`;
            } else {
                faultStatusElement.textContent = "No active faults - System operating normally";
            }
            faultStatusElement.style.color = "#28a745";
        } else {
            faultStatusElement.textContent = `Active faults: ${activeFaults.join(", ")} - Repair work order required`;
            faultStatusElement.style.color = "#dc3545";
        }
    }
    
    // Activate Faults button removed - Road Damage now triggers video directly
    // Conveyer fault still uses checkbox + processing options approach
    
    document.getElementById("restoreSystem").addEventListener("click", async function() {
        console.log('=== Restore System clicked ===');
        
        // Set factory status back to fixed - CRITICAL: This triggers the external fix process
        fetch('/status/simple/set?value=fixed', { 
            method: 'GET' 
        }).then(response => {
            console.log('‚úÖ Restore - Fixed status set:', response.ok, response.status);
            return response.text();
        }).then(text => {
            console.log('Restore API response:', text);
        }).catch(e => {
            console.error('‚ùå Restore API call failed:', e);
        });
        
        conveyerFaultActive = false;
        roadDamageActive = false;
        
        // Hide inventory approval section
        const inventoryApprovalDiv = document.getElementById('inventoryApproval');
        if (inventoryApprovalDiv) {
            inventoryApprovalDiv.style.display = 'none';
        }
        
        // Hide 3D model and show inactive message
        const container3D = document.getElementById('threejs-container-twin');
        const inactiveMsg = document.getElementById('inactive3DMessage');
        if (container3D && inactiveMsg) {
            container3D.style.display = 'none';
            inactiveMsg.style.display = 'flex';
        }
        
        // Stop 3D model rotation
        if (typeof isRotating3D !== 'undefined') {
            isRotating3D = false;
            const toggleBtn = document.getElementById('toggleRotation3D');
            if (toggleBtn) toggleBtn.innerHTML = "‚ñ∂Ô∏è Play";
        }
        
        // Remove conveyor route from map
        if (conveyorRouteLayer && mapInstance) {
            mapInstance.removeLayer(conveyorRouteLayer);
            conveyorRouteLayer = null;
        }
        
        // Reset conveyor fault button
        const conveyerFaultBtn = document.getElementById('conveyerFaultBtn');
        if (conveyerFaultBtn) {
            conveyerFaultBtn.innerHTML = "‚öôÔ∏è Simulate Conveyer Belt Failure";
            conveyerFaultBtn.disabled = false;
        }
        
        const now = new Date();
        localStorage.setItem('lastRepaired', now.toLocaleString());
        
        updateStatusDisplays();
        updateFaultStatusMessage();
        document.getElementById("apiResults").style.display = "none";
        
        alert("‚úÖ All systems restored to normal operation!");
    });
    
    // Approve Replacement Button - resets factory to fixed status but KEEPS 3D model visible
    document.getElementById("approveReplacementBtn").addEventListener("click", async function() {
        this.innerHTML = "‚öôÔ∏è Processing...";
        this.disabled = true;
        
        try {
            // Set factory status back to fixed - CRITICAL: This triggers the external fix process
            fetch('/status/simple/set?value=fixed', { 
                method: 'GET' 
            }).then(response => {
                console.log('Fixed status set:', response.ok);
            }).catch(e => console.warn('Fixed status API call failed:', e));
            
            // Hide the inventory approval section
            const inventoryApprovalDiv = document.getElementById('inventoryApproval');
            if (inventoryApprovalDiv) {
                inventoryApprovalDiv.style.display = 'none';
            }
            
            // Reset fault states
            conveyerFaultActive = false;
            
            // DO NOT hide 3D model - keep it visible after approval
            // Only "Restore System" button will hide it
            
            // Remove conveyor route from map
            if (conveyorRouteLayer && mapInstance) {
                mapInstance.removeLayer(conveyorRouteLayer);
                conveyorRouteLayer = null;
            }
            
            updateStatusDisplays();
            updateFaultStatusMessage();
            
            // Reset conveyor fault button
            const conveyerFaultBtn = document.getElementById('conveyerFaultBtn');
            if (conveyerFaultBtn) {
                conveyerFaultBtn.innerHTML = "‚öôÔ∏è Simulate Conveyer Belt Failure";
                conveyerFaultBtn.disabled = false;
            }
            
            alert("‚úÖ Replacement approved! Factory status restored to normal operation.");
            
        } catch (error) {
            console.error('Error approving replacement:', error);
            this.innerHTML = "‚úÖ Approve Replacement";
            this.disabled = false;
        }
    });
    
    document.getElementById("approveRepair").addEventListener("click", async function() {
        console.log('=== Approve Repair clicked ===');
        
        // Set factory status back to fixed
        fetch('/status/simple/set?value=fixed', { 
            method: 'GET' 
        }).then(response => {
            console.log('‚úÖ Approve Repair - Fixed status set:', response.ok, response.status);
            return response.text();
        }).then(text => {
            console.log('Approve Repair API response:', text);
        }).catch(e => {
            console.error('‚ùå Approve Repair API call failed:', e);
        });
        
        conveyerFaultActive = false;
        roadDamageActive = false;
        
        const now = new Date();
        localStorage.setItem('lastRepaired', now.toLocaleString());
        
        updateStatusDisplays();
        updateFaultStatusMessage();
        document.getElementById("apiResults").style.display = "none";
        
        alert("üîß Repair work order approved! All systems restored.");
    });
    
    updateStatusDisplays();
    updateFaultStatusMessage();
    setInterval(updateTimestamp, 30000);
});

// ============================================
// 3D Digital Twin Viewer Initialization
// ============================================
let scene3D, camera3D, renderer3D, model3D;
let isRotating3D = false; // Start paused - will activate when conveyer fault is triggered

function init3DViewer() {
    const container = document.getElementById('threejs-container-twin');
    if (!container) return;
    
    const loadingMessage = document.getElementById('loadingMessage3D');
    
    // Scene setup
    scene3D = new THREE.Scene();
    scene3D.background = new THREE.Color(0x111111);
    
    // Camera setup - positioned for better model visibility
    camera3D = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
    camera3D.position.set(1.5, 0.8, 1.5);
    
    // Renderer setup
    renderer3D = new THREE.WebGLRenderer({ antialias: true });
    renderer3D.setSize(container.offsetWidth, container.offsetHeight);
    renderer3D.setPixelRatio(window.devicePixelRatio);
    renderer3D.shadowMap.enabled = true;
    
    container.appendChild(renderer3D.domElement);
    
    // Lighting
    const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
    scene3D.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(10, 10, 5);
    directionalLight.castShadow = true;
    scene3D.add(directionalLight);
    
    const pointLight = new THREE.PointLight(0xCC5500, 0.5);
    pointLight.position.set(-10, -10, -5);
    scene3D.add(pointLight);
    
    // Load FBX model
    const loader = new THREE.FBXLoader();
    loader.load(
        'images-aiholo/ConveyorBelt_3.fbx',
        function (object) {
            object.scale.setScalar(0.08);
            object.position.set(0, 0, 0);
            
            object.traverse(function (child) {
                if (child.isMesh) {
                    child.castShadow = true;
                    child.receiveShadow = true;
                }
            });
            
            model3D = object;
            scene3D.add(model3D);
            loadingMessage.style.display = 'none';
        },
        function (progress) {
            const percentComplete = (progress.loaded / progress.total * 100) || 0;
            loadingMessage.textContent = `Loading... ${Math.round(percentComplete)}%`;
        },
        function (error) {
            console.error('Error loading 3D model:', error);
            createFallbackModel3D();
            loadingMessage.style.display = 'none';
        }
    );
    
    // Simple orbit controls
    setupOrbitControls3D(container);
    
    // Start animation
    animate3D();
}

function createFallbackModel3D() {
    const group = new THREE.Group();
    
    const beltGeometry = new THREE.BoxGeometry(4, 0.2, 1);
    const beltMaterial = new THREE.MeshPhongMaterial({ color: 0x333333 });
    const belt = new THREE.Mesh(beltGeometry, beltMaterial);
    group.add(belt);
    
    for (let i = -1.5; i <= 1.5; i += 1) {
        const rollerGeometry = new THREE.CylinderGeometry(0.1, 0.1, 1.2, 12);
        const rollerMaterial = new THREE.MeshPhongMaterial({ color: 0x666666 });
        const roller = new THREE.Mesh(rollerGeometry, rollerMaterial);
        roller.position.set(i, -0.2, 0);
        roller.rotation.z = Math.PI / 2;
        group.add(roller);
    }
    
    model3D = group;
    scene3D.add(model3D);
}

function setupOrbitControls3D(container) {
    let isMouseDown = false;
    let mouseX = 0, mouseY = 0;
    let targetRotationX = 0, targetRotationY = 0;
    let targetDistance = 2;
    
    container.addEventListener('mousedown', function(e) {
        isMouseDown = true;
        mouseX = e.clientX;
        mouseY = e.clientY;
    });
    
    container.addEventListener('mousemove', function(e) {
        if (isMouseDown) {
            targetRotationY += (e.clientX - mouseX) * 0.01;
            targetRotationX += (e.clientY - mouseY) * 0.01;
            mouseX = e.clientX;
            mouseY = e.clientY;
        }
    });
    
    container.addEventListener('mouseup', () => isMouseDown = false);
    
    container.addEventListener('wheel', function(e) {
        e.preventDefault();
        targetDistance += e.deltaY * 0.01;
        targetDistance = Math.max(0.5, Math.min(8, targetDistance));
    });
    
    window.updateCamera3D = function() {
        camera3D.position.x = Math.cos(targetRotationY) * Math.cos(targetRotationX) * targetDistance;
        camera3D.position.y = Math.sin(targetRotationX) * targetDistance;
        camera3D.position.z = Math.sin(targetRotationY) * Math.cos(targetRotationX) * targetDistance;
        camera3D.lookAt(0, 0, 0);
    };
}

function animate3D() {
    requestAnimationFrame(animate3D);
    
    if (isRotating3D && model3D) {
        model3D.rotation.y += 0.003;
    }
    
    if (window.updateCamera3D) {
        window.updateCamera3D();
    }
    
    renderer3D.render(scene3D, camera3D);
}

// Do NOT initialize 3D viewer on page load - only when conveyer fault is triggered
// document.addEventListener("DOMContentLoaded", function() {
//     setTimeout(init3DViewer, 500);
// });

// Control buttons for 3D viewer
document.addEventListener("DOMContentLoaded", function() {
    setTimeout(function() {
        const resetBtn = document.getElementById('resetView3D');
        const toggleBtn = document.getElementById('toggleRotation3D');
        const wireframeBtn = document.getElementById('toggleWireframe3D');
        
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                if (model3D) model3D.rotation.set(0, 0, 0);
                camera3D.position.set(1.5, 0.8, 1.5);
                camera3D.lookAt(0, 0, 0);
            });
        }
        
        if (toggleBtn) {
            toggleBtn.addEventListener('click', function() {
                isRotating3D = !isRotating3D;
                this.innerHTML = isRotating3D ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Play';
            });
        }
        
        if (wireframeBtn) {
            wireframeBtn.addEventListener('click', function() {
                if (model3D) {
                    model3D.traverse(function(child) {
                        if (child.material) {
                            child.material.wireframe = !child.material.wireframe;
                        }
                    });
                }
            });
        }
    }, 1000);
});

// Handle window resize for 3D viewer
window.addEventListener('resize', function() {
    const container = document.getElementById('threejs-container-twin');
    if (container && camera3D && renderer3D) {
        camera3D.aspect = container.offsetWidth / container.offsetHeight;
        camera3D.updateProjectionMatrix();
        renderer3D.setSize(container.offsetWidth, container.offsetHeight);
    }
});

// ============================================
// Video Analysis Panel
// ============================================
document.addEventListener("DOMContentLoaded", function() {
    const phyllVideoPanel = document.getElementById("phyllVideoPanel");
    const startMonitoringBtn = document.getElementById("startMonitoringVideo");
    const analysisResultsPanel = document.getElementById("analysisResultsPanel");
    
    if (startMonitoringBtn && phyllVideoPanel) {
        startMonitoringBtn.addEventListener("click", function() {
            phyllVideoPanel.currentTime = 0;
            phyllVideoPanel.play().catch(err => console.log("Video autoplay prevented:", err));
            
            this.disabled = true;
            this.innerHTML = "üé• Monitoring Active...";
            
            analysisResultsPanel.innerHTML = '<p style="font-size: 11px;"><em>Video playing... Analysis will appear when video ends.</em></p>';
        });
        
        phyllVideoPanel.addEventListener("ended", function() {
            loadVideoGeoJSONData();
            
            // Wait a moment for map to be ready, then load obstacles
            setTimeout(function() {
                loadObstacleMarkers();
            }, 500);
            
            startMonitoringBtn.disabled = false;
            startMonitoringBtn.innerHTML = "üé• Start Live Monitoring";
        });
    }
    
    function loadVideoGeoJSONData() {
        fetch('images-aiholo/phyll oracle.geojson')
            .then(response => response.json())
            .then(data => displayVideoGeoJSONResults(data))
            .catch(error => {
                analysisResultsPanel.innerHTML = `<p style="font-size: 11px;"><strong>‚ùå Error:</strong> Unable to load analysis data</p>`;
            });
    }
    
    function displayVideoGeoJSONResults(geoJsonData) {
        if (!geoJsonData || !geoJsonData.features) {
            analysisResultsPanel.innerHTML = '<p style="font-size: 11px;"><strong>‚ùå Error:</strong> Invalid data format</p>';
            return;
        }
        
        const assetStats = {
            total: geoJsonData.features.length,
            byType: {},
            byStatus: {},
            atRisk: []
        };
        
        geoJsonData.features.forEach(feature => {
            const props = feature.properties;
            assetStats.byType[props.type] = (assetStats.byType[props.type] || 0) + 1;
            assetStats.byStatus[props.status] = (assetStats.byStatus[props.status] || 0) + 1;
            
            if (props.status === 'at_risk' || props.severity === 'high' || props.severity === 'critical') {
                assetStats.atRisk.push({
                    id: props.asset_id,
                    type: props.type,
                    severity: props.severity
                });
            }
        });
        
        let resultsHTML = `
            <h6 style="font-size: 12px; margin-bottom: 8px;">üìä Analysis Complete:</h6>
            <div style="background: rgba(0, 100, 0, 0.2); padding: 8px; border-radius: 4px; margin: 5px 0; font-size: 10px;">
                <p style="margin: 3px 0;"><strong>Assets:</strong> ${assetStats.total}</p>
                <p style="margin: 3px 0;"><strong>Types:</strong> ${Object.keys(assetStats.byType).join(', ')}</p>
            </div>
        `;
        
        if (assetStats.atRisk.length > 0) {
            resultsHTML += `
                <div style="background: rgba(255, 193, 7, 0.2); border: 1px solid #ffc107; padding: 8px; border-radius: 4px; margin: 5px 0; font-size: 10px;">
                    <h6 style="font-size: 11px; margin-bottom: 5px;">‚ö†Ô∏è Priority Issues (${assetStats.atRisk.length}):</h6>
            `;
            assetStats.atRisk.slice(0, 2).forEach(item => {
                resultsHTML += `<p style="margin: 3px 0;">${item.id} (${item.type}) - ${item.severity}</p>`;
            });
            resultsHTML += `</div>`;
        }
        
        analysisResultsPanel.innerHTML = resultsHTML;
    }
    
    // Load and display obstacle markers on map
    function loadObstacleMarkers() {
        if (!mapInstance) {
            console.warn('Map not initialized yet, retrying obstacle loading in 1 second...');
            setTimeout(loadObstacleMarkers, 1000);
            return;
        }
        
        const obstacleUrl = 'https://rddainsuh6u1okc-dlapp1.adb.us-ashburn-1.oraclecloudapps.com/ords/sandbox/aiw25/thr2698/geojson/return%20where%20are%20the%20driving%20obstacles';
        console.log('Fetching obstacles from:', obstacleUrl);
        
        fetch(obstacleUrl)
            .then(response => {
                console.log('Obstacle response status:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ Obstacle data loaded:', data);
                console.log('Data type:', data.type);
                console.log('Features count:', data.features ? data.features.length : 'N/A');
                
                if (!data || (!data.features && data.type !== 'Feature' && data.type !== 'FeatureCollection')) {
                    console.error('‚ùå Invalid obstacle data format:', data);
                    alert('Invalid obstacle data received');
                    return;
                }
                
                // Define custom icon for obstacles
                const obstacleIcon = L.divIcon({
                    className: 'obstacle-marker',
                    html: '<div style="background: #ff0000; border: 2px solid #fff; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 14px;">üöß</div>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                
                // Add markers for each obstacle
                const obstacleLayer = L.geoJSON(data, {
                    pointToLayer: function(feature, latlng) {
                        console.log('Adding obstacle marker at:', latlng, 'for feature:', feature);
                        return L.marker(latlng, { icon: obstacleIcon });
                    },
                    onEachFeature: function(feature, layer) {
                        if (feature.properties) {
                            const props = feature.properties;
                            console.log('Obstacle properties:', props);
                            const popupContent = `
                                <div style="font-family: Arial, sans-serif; font-size: 11px;">
                                    <h4 style="margin: 0 0 5px 0; color: #d32f2f; font-size: 13px;">üöß Road Obstacle</h4>
                                    ${props.ASSET_ID ? `<p style="margin: 2px 0;"><strong>Asset ID:</strong> ${props.ASSET_ID}</p>` : ''}
                                    ${props.TYPE ? `<p style="margin: 2px 0;"><strong>Type:</strong> ${props.TYPE}</p>` : ''}
                                    ${props.SEVERITY ? `<p style="margin: 2px 0;"><strong>Severity:</strong> ${props.SEVERITY}</p>` : ''}
                                    ${props.CONDITION ? `<p style="margin: 2px 0;"><strong>Condition:</strong> ${props.CONDITION}</p>` : ''}
                                    ${props.STATUS ? `<p style="margin: 2px 0;"><strong>Status:</strong> ${props.STATUS}</p>` : ''}
                                    ${props.DESCRIPTION ? `<p style="margin: 2px 0;"><em>${props.DESCRIPTION}</em></p>` : ''}
                                </div>
                            `;
                            layer.bindPopup(popupContent);
                        }
                    }
                }).addTo(mapInstance);
                
                console.log('‚úÖ Obstacle layer added to map');
                
                // Try to fit bounds to show obstacles
                try {
                    const bounds = obstacleLayer.getBounds();
                    console.log('Obstacle bounds:', bounds);
                    mapInstance.fitBounds(bounds, { padding: [50, 50], maxZoom: mapInstance.getZoom() });
                    console.log('‚úÖ Map adjusted to show obstacles');
                } catch (e) {
                    console.log('No bounds to fit:', e);
                }
                
                alert('‚úÖ ' + (data.features ? data.features.length : 1) + ' obstacle marker(s) added!');
            })
            .catch(error => {
                console.error('‚ùå Error loading obstacles:', error);
                alert('Error loading obstacles: ' + error.message);
            });
    }
});

// ============================================
// Map Panel Initialization
// ============================================
let mapInstance;
let conveyorRouteLayer; // Store reference to conveyor route layer

document.addEventListener("DOMContentLoaded", function() {
    setTimeout(function() {
        initializeMap();
    }, 1000);
});

function loadConveyorBeltRoute() {
    console.log('=== loadConveyorBeltRoute called ===');
    
    if (!mapInstance) {
        console.error('‚ùå Map not initialized yet, cannot add conveyor route');
        alert('Map not ready. Please wait a moment and try again.');
        return;
    }
    
    console.log('‚úÖ Map instance found, proceeding to load route');
    
    // Remove existing conveyor route if it exists
    if (conveyorRouteLayer) {
        console.log('Removing existing conveyor route layer');
        mapInstance.removeLayer(conveyorRouteLayer);
    }
    
    const conveyorRouteUrl = 'https://rddainsuh6u1okc-dlapp1.adb.us-ashburn-1.oraclecloudapps.com/ords/sandbox/aiw25/thr2698/geojson/return%20what%20is%20the%20best%20supplier%20for%20conveyor%20belt%20replacement';
    
    console.log('Fetching conveyor route from:', conveyorRouteUrl);
    
    fetch(conveyorRouteUrl)
        .then(response => {
            console.log('Conveyor route response status:', response.status, response.statusText);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('‚úÖ Conveyor belt route data loaded:', data);
            console.log('Data type:', data.type);
            console.log('Features count:', data.features ? data.features.length : 'N/A');
            
            if (!data || (!data.features && data.type !== 'Feature' && data.type !== 'FeatureCollection')) {
                console.error('‚ùå Invalid GeoJSON format:', data);
                alert('Invalid conveyor route data received');
                return;
            }
            
            conveyorRouteLayer = L.geoJSON(data, {
                style: { 
                    color: "#ff6b00", 
                    weight: 5, 
                    opacity: 0.9,
                    dashArray: "10, 5"
                },
                onEachFeature: function(feature, layer) {
                    console.log('Adding feature:', feature);
                    if (feature.properties) {
                        const props = feature.properties;
                        const popupContent = `
                            <div style="font-family: Arial, sans-serif; font-size: 12px;">
                                <h4 style="margin: 0 0 8px 0; color: #ff6b00; font-size: 14px;">‚öôÔ∏è Conveyor Belt Replacement Route</h4>
                                ${props.NAME ? `<p style="margin: 3px 0;"><strong>Route:</strong> ${props.NAME}</p>` : ''}
                                ${props.DRIVE_TIME ? `<p style="margin: 3px 0;"><strong>Drive Time:</strong> ${props.DRIVE_TIME}</p>` : ''}
                            </div>
                        `;
                        layer.bindPopup(popupContent);
                    }
                }
            }).addTo(mapInstance);
            
            console.log('‚úÖ Conveyor route layer added to map');
            
            // Fit map to show both routes if original route exists
            try {
                const bounds = conveyorRouteLayer.getBounds();
                console.log('Route bounds:', bounds);
                mapInstance.fitBounds(bounds, { padding: [30, 30] });
                console.log('‚úÖ Map fitted to conveyor route bounds');
            } catch (e) {
                console.error('Error fitting bounds:', e);
            }
            
            console.log('‚úÖ Conveyor belt route successfully added to map');
            alert('‚úÖ Conveyor belt route added to map!');
        })
        .catch(error => {
            console.error('‚ùå Error loading conveyor belt route:', error);
            alert('Error loading conveyor route: ' + error.message);
        });
}

function initializeMap() {
    const mapContainer = document.getElementById('mapContainer');
    if (!mapContainer || mapInstance) return;
    
    try {
        mapInstance = L.map(mapContainer).setView([0, 0], 2);
        
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(mapInstance);
        
        // Apply dark mode filter to tiles
        const style = document.createElement('style');
        style.textContent = `
            #mapContainer .leaflet-tile {
                filter: invert(100%) hue-rotate(180deg) brightness(90%) contrast(85%);
            }
        `;
        document.head.appendChild(style);
        
        const apiUrl = 'https://rddainsuh6u1okc-dlapp1.adb.us-ashburn-1.oraclecloudapps.com/ords/sandbox/aiw25/route/Get%20route%20from%20supplier%20%22Hudson%20-%20Upton%22%20to%20the%20%22Philadelphia%20Facility%22%20as%20a%20geojson%20document';
        
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                const loadingMsg = document.getElementById('mapLoadingMessage');
                if (loadingMsg) loadingMsg.remove();
                
                const routeFeature = data.features && data.features[0] ? data.features[0] : data;
                
                const routeLayer = L.geoJSON(routeFeature, {
                    style: { 
                        color: "#00e5ff", 
                        weight: 4, 
                        opacity: 0.95,
                        dashArray: "5, 5"
                    }
                }).addTo(mapInstance);
                
                if (routeFeature.properties) {
                    const popupContent = `
                        <div style="font-family: Arial, sans-serif; font-size: 12px;">
                            <h4 style="margin: 0 0 8px 0; color: #333; font-size: 14px;">üöõ Supply Route</h4>
                            ${routeFeature.properties.Supplier ? `<p style="margin: 3px 0;"><strong>From:</strong> ${routeFeature.properties.Supplier}</p>` : ''}
                            ${routeFeature.properties.Facility ? `<p style="margin: 3px 0;"><strong>To:</strong> ${routeFeature.properties.Facility}</p>` : ''}
                        </div>
                    `;
                    routeLayer.bindPopup(popupContent);
                }
                
                mapInstance.fitBounds(routeLayer.getBounds(), { padding: [20, 20] });
            })
            .catch(error => {
                console.error('Error loading route:', error);
                const loadingMsg = document.getElementById('mapLoadingMessage');
                if (loadingMsg) {
                    loadingMsg.innerHTML = '‚ùå Route loading failed';
                    loadingMsg.style.background = 'rgba(255,0,0,0.8)';
                }
                mapInstance.setView([40.0441, -75.4496], 10);
            });
    } catch (error) {
        console.error('Map initialization error:', error);
    }
}

// Handle window resize for map
window.addEventListener('resize', function() {
    if (mapInstance) {
        mapInstance.invalidateSize();
    }
});
</script>

</body>
</html>
