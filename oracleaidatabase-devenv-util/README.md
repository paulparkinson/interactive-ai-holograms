# Oracle + Vector + Spring scaffold

This scaffold brings up:
- Oracle Database (Oracle free image with 26ai support)
- A Python FastAPI `python-app` which:
  - extracts text from uploaded PDFs/images (Apache Tika)
  - computes embeddings using ONNX models or Oracle VECTOR_EMBEDDING()
  - stores document metadata and vectors in Oracle with chunking support
- A Spring Boot app that provides a web UI and proxies to the Python backend
- **Three Vector Embedding Modes:**
  1. **Oracle Native** - Uses `VECTOR_EMBEDDING()` for fully database-side embeddings (requires model import)
  2. **Oracle Hybrid** - Python ONNX embeddings + Oracle `TO_VECTOR()` storage + `VECTOR_DISTANCE()` search
  3. **Python Fallback** - Python ONNX + JSON storage + NumPy cosine similarity (Oracle 19c+ compatible)

## Quick Start

1. Clone the repository and navigate to it
2. **Choose your platform** and navigate to the appropriate scripts folder:
   - Linux: `cd scripts/linux/`
   - macOS: `cd scripts/macos/`
   - Windows: `cd scripts/windows/`
3. Make scripts executable (Linux/macOS only): `chmod +x *.sh`
4. Run `./start.sh` (or `.\start.ps1` on Windows) and answer prompts
5. After startup visit `http://localhost:8080` to upload files and configure modes

**Container Runtime Support**: All scripts support both Docker and Podman. You'll be prompted to choose during setup, and your choice will be saved in `.env`.

## Vector Modes Explained

### Oracle Native Mode (VECTOR_EMBEDDING)
- **Embeddings**: Generated by Oracle database using `VECTOR_EMBEDDING()` function
- **Storage**: Oracle VECTOR datatype
- **Search**: Oracle `VECTOR_DISTANCE()` SQL function
- **Requirements**: 
  - Oracle 26ai or later
  - ONNX model imported into database (use the "Import ONNX Model" button in the web UI)
- **Setup**: Select "Oracle Native" mode in the web UI and click "Import ONNX Model" to download and import the model automatically
- **Advantages**: Fastest, all processing in-database, no network overhead
- **Use Case**: Production deployments with high performance requirements

### Oracle Hybrid Mode (Default, Recommended)
- **Embeddings**: Generated by Python using ONNX Runtime with all-MiniLM-L6-v2
- **Storage**: Oracle VECTOR datatype via `TO_VECTOR()`
- **Search**: Oracle `VECTOR_DISTANCE()` SQL function
- **Requirements**: Oracle 26ai or later
- **Setup**: No setup required - works immediately after starting the stack
- **Advantages**: Flexible, models managed in Python, easy model updates, no database privileges needed
- **Use Case**: Development, testing, production deployments without database-side model management

### Python Fallback Mode
- **Embeddings**: Generated by Python using ONNX Runtime
- **Storage**: JSON CLOB (no VECTOR type)
- **Search**: Python NumPy cosine similarity
- **Requirements**: Oracle 19c or later
- **Setup**: No setup required
- **Advantages**: Works with older Oracle versions
- **Use Case**: Legacy database environments, Oracle 19c/21c compatibility

**Note**: ONNX models are downloaded automatically by `start.sh`/`start.ps1` if you answer "y" to the model download prompts. Oracle Native mode additionally requires importing models into the database, which can be done with one click in the web UI.

## Quick Start

### Prerequisites
- Docker or Podman and Docker/Podman Compose installed
- Git (to clone the repository)
- **Linux/macOS**: Bash shell
- **Windows**: PowerShell 5.1+ or PowerShell Core 7+

### Running the Stack

**Linux:**
```bash
cd scripts/linux/
chmod +x *.sh
./start.sh
```

**macOS:**
```bash
cd scripts/macos/
chmod +x *.sh
./start.sh
```

**Windows:**
```powershell
cd scripts\windows\
.\start.ps1
```

### What the Setup Does

The `start.sh` (Linux/macOS) or `start.ps1` (Windows) script will:

1. **Prompt for configuration**:
   - **Container runtime** (docker or podman, default: docker)
   - Oracle DB admin user (default: PDBADMIN)
   - Oracle DB password
   - Oracle DB service name (default: FREEPDB1)
   - Host path for Oracle data (default: `/data/oracle` on Linux, `C:\data\oracle` on Windows)
   - Whether to download text embedding model
   - Whether to download image embedding model
   - Whether to use Oracle 26ai+ native VECTOR search (recommended: yes)

2. **Create `.env` file** with your configuration

3. **Download models** (if requested):
   - Text model: sentence-transformers/all-MiniLM-L6-v2 (ONNX)
   - Image model: CLIP ViT-B/32 (ONNX)

4. **Build and start all services using Docker Compose**:
   - **Oracle Database 26ai Free** (container: `oracle-free`)
     - Automatically pulls official Oracle Database Free image
     - Creates database with configured password
     - Initializes with FREEPDB1 pluggable database
     - Persists data to configured host directory
   - **Python FastAPI backend** (container: `python-app`)
     - Builds from `./python-app/Dockerfile`
     - Installs dependencies: FastAPI, oracledb, onnxruntime, transformers, etc.
     - Loads ONNX models for embeddings
     - Connects to Oracle DB automatically
     - Creates tables if they don't exist
   - **Spring Boot web UI** (container: `spring-app`)
     - Builds from `./spring-app/Dockerfile`
     - Maven builds the Spring Boot application
     - Connects to Python backend automatically
     - Serves web interface on port 8080

5. **Services will be available at**:
   - **Web UI**: http://localhost:8080 - Upload files, search, chat with RAG
   - **Python API**: http://localhost:8001 - REST API with OpenAPI docs at /docs
   - **Oracle DB**: localhost:1521 - Connect with SQL clients

### ✅ Zero Configuration Required

**Yes, you can take this repo to any machine with Docker or Podman installed and just run the appropriate start script from `scripts/linux/`, `scripts/macos/`, or `scripts/windows/`!**

The setup script handles:
- ✅ Creating all configuration files
- ✅ Downloading embedding models (optional)
- ✅ Pulling Docker images (Oracle Database, base images for Python/Java)
- ✅ Building application containers
- ✅ Creating Docker networks and volumes
- ✅ Initializing the Oracle database
- ✅ Creating database schema and tables
- ✅ Connecting all services together

**First run takes longer** (~10-15 minutes) due to:
- Oracle Database image download (~3.5GB)
- Database initialization
- Maven dependencies download
- Python packages installation
- ONNX model downloads (if selected)

**Subsequent runs are fast** (~30 seconds) as images and dependencies are cached.

### Available Scripts

All scripts are organized in platform-specific folders: `scripts/linux/`, `scripts/macos/`, and `scripts/windows/`.

**Note**: All scripts support both Docker and Podman. Your container runtime choice is saved in `.env` during initial setup.

| Linux/macOS | Windows | Description |
|-------------|---------|-------------|
| `start.sh` | `start.ps1` | Interactive setup and start all services |
| `teardown.sh` | `teardown.ps1` | Stop all services and remove volumes |
| `rebuild-python.sh` | `rebuild-python.ps1` | Rebuild and restart Python app only |
| `rebuild-spring.sh` | `rebuild-spring.ps1` | Rebuild and restart Spring app only |
| `rebuild-all.sh` | `rebuild-all.ps1` | Rebuild and restart both apps |
| `logs-python.sh` | `logs-python.ps1` | View Python app logs |
| `logs-spring.sh` | `logs-spring.ps1` | View Spring app logs |
| `logs-oracle.sh` | `logs-oracle.ps1` | View Oracle DB logs |
| `diagnose-docker.sh` | `diagnose-docker.ps1` | Diagnose container runtime configuration |

### Teardown

**Linux/macOS:**
```bash
cd scripts/linux/  # or scripts/macos/
./teardown.sh
```

**Windows:**
```powershell
cd scripts\windows\
.\teardown.ps1
```

This removes all containers, volumes, and networks created by the stack.

## API Endpoints & Usage

### Upload Documents

**Via Spring Boot web UI** (recommended for interactive use):
```
http://localhost:8080
```

**Via Spring Boot REST API:**
```bash
curl -s -F "file=@/path/to/document.pdf" http://localhost:8080/upload | jq .
```

**Direct to FastAPI** (bypasses Spring):
```bash
curl -s -F "file=@/path/to/document.pdf" http://localhost:8001/embed | jq .
curl -s -F "file=@/path/to/image.png" http://localhost:8001/embed | jq .
```

### Search Documents

**Via Web UI** (recommended):
```
http://localhost:8080
```
The web interface provides:
- Interactive search with real-time results
- Visual similarity scores and document previews
- Mode indicator (Oracle VECTOR_DISTANCE vs Python NumPy)
- Document listing and management
- File upload with drag-and-drop support

**Via API**:
```bash
curl -s -X POST -F "q=database systems" -F "top_k=5" http://localhost:8001/search | jq .
```

Example response:
```json
{
  "query": "database systems",
  "results": [
    {"id": "...", "name": "oracle_guide.pdf", "score": 0.72},
    {"id": "...", "name": "sql_tutorial.pdf", "score": 0.58}
  ],
  "mode": "oracle_vector"
}
```

**Note**: The `mode` field indicates whether similarity was computed in Oracle (`oracle_vector`) or Python (`python_numpy`).

### List All Documents

```bash
curl -s http://localhost:8001/list | jq .
```

### Re-embed Documents

Re-embed all documents (useful after model changes):
```bash
curl -s -X POST http://localhost:8001/reembed | jq .
```

Re-embed specific documents (comma-separated IDs):
```bash
curl -s -X POST -F "doc_ids=id1,id2,id3" http://localhost:8001/reembed | jq .
```

### Logs & Debugging

View service logs:
```bash
./logs-python.sh   # FastAPI python-app logs
./logs-spring.sh   # Spring Boot logs
./logs-oracle.sh   # Oracle DB logs
```

Inspect Oracle stored documents:
```bash
sg docker -c 'docker exec oracle-free bash -c "echo '"'"'SELECT id, name FROM documents FETCH FIRST 10 ROWS ONLY;'"'"' | sqlplus -s SYSTEM/YourPassword@FREEPDB1"'
```

### Teardown

```bash
./teardown.sh && ./start.sh  # Clean restart
```

## Architecture Overview

### Components

**1. Spring Boot App** (`spring-app/`, port 8080)
- **Role**: Web UI and upload gateway
- **Tech**: Spring Boot + Thymeleaf + RestTemplate
- **Code**: `spring-app/src/main/java/com/example/demo/controller/UploadController.java`
- **Function**: Receives file uploads via HTML form, forwards multipart data to python-app `/embed` endpoint
- **Does NOT**: Process files, create embeddings, or query database

**2. Python FastAPI App** (`python-app/`, port 8001)
- **Role**: Document processing, embedding generation, and vector search
- **Tech**: FastAPI + ONNX Runtime + Transformers + Apache Tika + oracledb
- **Code**: `python-app/app.py`
- **Functions**:
  - Extracts text from PDFs using Apache Tika (requires Java)
  - Tokenizes text using `transformers` (sentence-transformers/all-MiniLM-L6-v2)
  - Generates 384-dim embeddings via ONNX model inference
  - Preprocesses images for CLIP-style models
  - Stores document text + vector embeddings in Oracle
  - **Performs vector similarity search in Python** (cosine similarity)
- **Key Functions**:
  - `embed_text()` - Tokenize and embed text (line ~120)
  - `embed_image()` - Preprocess and embed images (line ~170)
  - `/embed` endpoint - Upload and store (line ~205)
  - `/search` endpoint - Query and rank by similarity (line ~255)
  - `/list` endpoint - List all documents (line ~285)
  - `/reembed` endpoint - Re-embed existing docs (line ~295)

**3. Oracle Database** (`oracle`, port 1521)
- **Role**: Persistent storage AND vector similarity computation (26ai+)
- **Tech**: Oracle AI Database 26ai Free (23.26.0.0.0+) with native VECTOR datatype
- **Schema**: Table `documents` with columns:
  - `id` VARCHAR2(36) - UUID primary key
  - `name` VARCHAR2(256) - filename
  - `text` CLOB - extracted text content
  - `embedding` VECTOR(384, FLOAT32) - native vector column (26ai+ mode)
  - `vector` CLOB - JSON array fallback (legacy mode)
- **Performs**: Vector similarity calculations using `VECTOR_DISTANCE(embedding, query_vec, COSINE)` when USE_ORACLE_VECTOR_SEARCH=true
- **Note**: Tablespace must support ASSM (automatic segment space management). VECTOR columns created in USERS tablespace.

### Data Flow

**Upload Flow:**
1. User uploads PDF via browser → Spring Boot (`:8080/upload`)
2. Spring forwards multipart file → Python FastAPI (`:8001/embed`)
3. Python extracts text with Tika, tokenizes with transformers, generates embedding with ONNX
4. Python stores (id, name, text, vector) → Oracle database
5. Returns document ID and vector dimension

**Search Flow:**
1. User submits query → Python FastAPI (`:8001/search?q=...`)
2. Python tokenizes query text → generates query embedding (384-dim vector)
3. **Oracle 26ai+ mode**: Python sends query to Oracle; database computes `VECTOR_DISTANCE(embedding, query_vec, COSINE)` and returns top K ranked results
4. **Legacy mode**: Python fetches ALL document vectors from Oracle, computes cosine similarity in NumPy, sorts and returns top K
5. Search response includes `"mode": "oracle_vector"` or `"python_numpy"`

**Where Vector Operations Happen:**
- **Embedding creation**: Python (`embed_text()` in `app.py` line ~120)
- **Vector storage**: Oracle (native VECTOR(384, FLOAT32) column or CLOB JSON fallback)
- **Similarity computation**: 
  - **Oracle 26ai+ mode**: Database (`VECTOR_DISTANCE()` SQL function)
  - **Legacy mode**: Python (`/search` endpoint in `app.py` line ~310, using numpy)
- **Ranking**: Oracle (ORDER BY) or Python (sort by score)

**Configuration:**
Set `USE_ORACLE_VECTOR_SEARCH=true` in `.env` to use Oracle 26ai+ native vector search, or `false` for Python-based similarity (compatible with older Oracle versions).
